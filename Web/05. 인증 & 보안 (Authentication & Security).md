# 인증 & 보안 (Authentication & Security)

## 📖 개요

웹 보안은 웹 애플리케이션과 웹사이트를 다양한 공격으로부터 보호하는 것입니다. 사용자 데이터 보호와 서비스 안정성을 위해 필수적입니다.

웹 보안은 단순한 기술적 요구사항을 넘어서 사용자 신뢰와 비즈니스 지속가능성을 보장하는 핵심 요소입니다. 보안 취약점은 사용자의 개인정보 유출, 금융적 손실, 브랜드 이미지 훼손 등 심각한 결과를 초래할 수 있으며, 이는 웹 애플리케이션의 성공과 실패를 가르는 중요한 기준이 됩니다.

---

## 🤝 인증 방식: OAuth 2.0

**OAuth 2.0**은 제3자 인증을 위한 개방형 표준 프로토콜로, 사용자가 비밀번호를 직접 제공하지 않고도 다른 서비스의 정보에 접근할 수 있게 해주는 방식입니다. "소셜 로그인" 기능이 대표적인 OAuth 활용 사례입니다.

### 동작 방식 (Authorization Code Grant 흐름)

가장 일반적으로 사용되는 권한 부여 코드(Authorization Code) 방식의 동작 흐름은 다음과 같습니다.

1. 소셜에 권한 부여 요청
2. 소셜의 권한 서버는 인증 및 동의가 완료되면, 클라이언트로 다시 리디렉션시키면서 임시 권한 부여 코드(Authorization Code) 전달
3. 권한 부여 코드로 토큰 발급 및 관리

이러한 과정을 통해 사용자는 자신의 Google 비밀번호를 제3자 웹사이트에 노출하지 않고도 안전하게 로그인할 수 있습니다.

---

## 🔒 데이터 관련 위협 방어 전략

### **SQL 인젝션 (SQL Injection)**

공격자가 웹 애플리케이션의 입력 필드에 악성 SQL 코드를 삽입하여 데이터베이스를 조작하는 공격입니다. 이는 사용자 입력을 적절히 검증하거나 이스케이프하지 않을 때 발생할 수 있습니다. 사용자의 입력을 SQL 쿼리의 일부가 아닌 데이터로 취급하게 만들어 해결합니다.

### **XSS (Cross-Site Scripting)**

공격자가 웹 페이지에 악성 스크립트를 삽입하여 다른 사용자의 브라우저에서 실행되도록 하는 공격입니다. 이를 통해 사용자의 세션 쿠키를 탈취하거나, 개인정보를 빼내거나, 웹사이트의 내용을 변조할 수 있습니다.

- **입력 데이터 검증 및 이스케이프:** 사용자로부터 입력받은 데이터에 포함될 수 있는 스크립트 관련 문자(예: `<`, `>`, `"` 등)를 HTML 엔티티(`&lt;`, `&gt;`, `&quot;` 등)로 변환(이스케이프)하여 스크립트가 실행되지 않도록 합니다.
- **출력 시 이스케이프:** 데이터베이스나 파일에서 읽어온 데이터를 HTML에 출력할 때, 해당 데이터에 포함된 스크립트가 실행되지 않도록 이스케이프 처리를 해야 합니다.
- **Content Security Policy (CSP):** 브라우저에 신뢰할 수 있는 스크립트 소스를 명시하여, 허용되지 않은 외부 스크립트가 실행되는 것을 방지하는 강력한 보안 정책입니다. `Content-Security-Policy` HTTP 헤더를 통해 설정할 수 있습니다.

### **CSRF (Cross-Site Request Forgery)**

공격자가 인증된 사용자의 권한을 이용하여 사용자가 의도하지 않은 작업을 수행하도록 하는 공격입니다. 이는 사용자가 악성 웹사이트를 방문하거나 이메일의 링크를 클릭할 때 발생할 수 있습니다. 방어 방법으로는 CSRF 토큰 사용, SameSite 쿠키 설정, Referer 헤더 검증, 사용자 확인 절차 추가 등이 있습니다.

### 파일 업로드 보안

파일 업로드는 웹 셸(web shell)과 같은 악성 파일이 서버에 업로드되어 실행될 경우 심각한 보안 위협이 될 수 있습니다. 따라서 파일 업로드 기능은 신중하게 구현해야 합니다.

다음과 같은 조치를 통해 파일 업로드 취약점을 방어할 수 있습니다:

- **파일 타입 검증:** `Content-Type` 헤더(MIME 타입)와 파일 확장자를 모두 검증하여 허용된 파일 형식만 업로드되도록 제한합니다.
- **파일 크기 제한:** 비정상적으로 큰 파일 업로드를 막아 서비스 거부(DoS) 공격을 방지합니다.
- **안전한 파일명 사용:** 사용자가 입력한 파일명 대신, 서버에서 임의의 고유한 파일명을 생성하여 저장합니다. 이는 경로 조작(Path Traversal) 공격을 방지하는 데 도움이 됩니다.
- **실행 권한 제거:** 업로드된 파일이 저장되는 디렉토리의 실행 권한을 제거하여, 웹 셸과 같은 스크립트가 실행되지 않도록 합니다.

```javascript
const multer = require("multer");
const path = require("path");

// 파일 타입 검증
const fileFilter = (req, file, cb) => {
  const allowedTypes = ["image/jpeg", "image/png", "image/gif"];

  if (allowedTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error("Invalid file type"), false);
  }
};

// 파일 크기 제한
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, "uploads/");
  },
  filename: (req, file, cb) => {
    // 원본 파일명 대신 안전한 파일명 생성
    const uniqueSuffix = Date.now() + "-" + Math.round(Math.random() * 1e9);
    cb(null, uniqueSuffix + path.extname(file.originalname));
  },
});

const upload = multer({
  storage: storage,
  fileFilter: fileFilter,
  limits: {
    fileSize: 5 * 1024 * 1024, // 5MB
    files: 1,
  },
});

// 파일 확장자 검증
function validateFileExtension(filename) {
  const allowedExtensions = [".jpg", ".jpeg", ".png", ".gif"];
  const ext = path.extname(filename).toLowerCase();
  return allowedExtensions.includes(ext);
}
```

### 보안 헤더 설정

```javascript
const helmet = require("helmet");

app.use(helmet());

// 추가 보안 헤더
app.use((req, res, next) => {
  // XSS 방지
  res.setHeader("X-XSS-Protection", "1; mode=block");

  // 클릭재킹 방지
  res.setHeader("X-Frame-Options", "DENY");

  // MIME 타입 스니핑 방지
  res.setHeader("X-Content-Type-Options", "nosniff");

  // HSTS (HTTPS 강제)
  res.setHeader(
    "Strict-Transport-Security",
    "max-age=31536000; includeSubDomains"
  );

  // Content Security Policy
  res.setHeader(
    "Content-Security-Policy",
    "default-src 'self'; " +
      "script-src 'self' 'unsafe-inline'; " +
      "style-src 'self' 'unsafe-inline'; " +
      "img-src 'self' data: https:; " +
      "font-src 'self'; " +
      "connect-src 'self';"
  );

  next();
});
```

## 보안 모범 사례

### 1. **보안 원칙**

**최소 권한 원칙:**

- 사용자에게 필요한 최소한의 권한만 부여
- 관리자 권한은 꼭 필요한 경우에만 사용

**⭐ 방어적 프로그래밍 ⭐:**

- 모든 입력 데이터 검증
- 예상치 못한 상황에 대한 안전 장치
- 실패 시 안전한 기본값 사용
