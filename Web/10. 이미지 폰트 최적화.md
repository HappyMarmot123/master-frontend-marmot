# 이미지 최적화

## 📖 개요

**이미지 최적화**는 웹 성능 향상을 위한 핵심 기법으로, 대용량 이미지의 전송/디코딩/렌더링 비용을 줄여 LCP, CLS, FCP 등 핵심 지표를 개선합니다. 대부분의 사이트에서 이미지가 전체 전송량의 다수를 차지하므로, 올바른 포맷 선택과 반응형 제공, 지연 로딩, 적절한 캐싱은 체감 속도에 직접적인 영향을 줍니다.

### 전략 개요

- **올바른 포맷**: AVIF/WebP 우선, 폴백 제공
- **반응형 제공**: `srcset`/`sizes`로 해상도·레이아웃에 맞춰 다운로드
- **안정적 레이아웃**: `width`/`height` 또는 `aspect-ratio`로 CLS 방지
- **지연 로딩**: `loading="lazy"`, `decoding="async"`, `fetchpriority`
- **압축·리사이즈**: 서버/빌드 또는 CDN 파라미터로 동적 최적화
- **아트 디렉션**: `picture` + `media`로 상황별 크롭/구성 제공

## 🖼️ 포맷 선택(AVIF/WebP/JPEG/PNG/SVG)

**권장 원칙**

- 사진류: AVIF > WebP > JPEG(품질 0.75~0.85)
- 그래픽/아이콘: SVG(벡터) 또는 PNG(투명 필요 시)
- 브라우저 지원이 불확실하면 `picture`로 폴백 구성

```html
<picture>
  <source srcset="image.avif" type="image/avif" />
  <source srcset="image.webp" type="image/webp" />
  <img src="image.jpg" alt="설명" width="1200" height="800" />
</picture>
```

- AVIF: 최고 수준 압축, 색상/아티팩트 품질 우수(인코딩 비용↑)
- WebP: 폭넓은 지원, 손실/무손실 모두 가능
- JPEG/PNG: 레거시 호환, 품질 대비 용량↑(필요 시만)

## 📐 레이아웃 안정성(CLS 방지)

이미지의 고정 치수를 제공하거나 **비율**을 명시하면, 로드 전에 자리 잡기가 완료되어 레이아웃 점프(CLS)를 줄일 수 있습니다.

```html
<!-- 고정 치수 명시 -->
<img src="hero.jpg" alt="Hero" width="1280" height="720" />

<!-- 유동 레이아웃: 비율 유지 -->
<img
  src="card.jpg"
  alt="Card"
  style="aspect-ratio: 4 / 3; width: 100%; height: auto;"
/>
```

- `width`/`height` 속성은 CSS 크기를 강제하지 않으며, **내재 비율 계산용 메타**로도 활용됩니다
- 카드·그리드 등에서는 `aspect-ratio`가 간편하고 안정적입니다

## 📱 반응형 이미지(srcset/sizes)

같은 이미지를 다양한 해상도/레이아웃에 맞게 자동 선택하도록 합니다.

```html
<img
  src="image-800.jpg"
  srcset="image-400.jpg 400w, image-800.jpg 800w, image-1200.jpg 1200w"
  sizes="(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 33vw"
  alt="반응형 이미지"
  width="1200"
  height="800"
/>
```

- `srcset`: 후보 이미지와 고유 너비를 선언
- `sizes`: 뷰포트 조건에 따른 실제 렌더 너비 예측값을 제공(다운로드 선택 정확도↑)
- 잘못된 `sizes`는 불필요한 큰 이미지를 받게 하므로, 레이아웃에 맞춰 주기적으로 점검

## 🎨 아트 디렉션(picture + media)

레이아웃/디바이스에 따라 구성을 변경해야 한다면 **아트 디렉션**이 필요합니다.

```html
<picture>
  <source media="(max-width: 768px)" srcset="image-mobile.jpg" />
  <source media="(max-width: 1200px)" srcset="image-tablet.jpg" />
  <img src="image-desktop.jpg" alt="아트 디렉션" width="1600" height="900" />
</picture>
```

- 단순 리사이즈가 아닌 **크롭·구성 변경**이 필요한 경우에만 사용

## 💤 지연 로딩/디코딩/우선순위

- `loading="lazy"`: 뷰포트 밖 이미지를 지연 로드(초기 네트워크 혼잡 감소)
- `decoding="async"`: 디코딩을 비동기화해 메인 스레드 블로킹 최소화
- `fetchpriority`: LCP 후보 이미지는 `high`, 지연 가능한 이미지는 `low`
- `preload`는 **정말 필요한 소수의 핵심 이미지**에만 적용(과도 사용 시 역효과)

```html
<!-- LCP 후보(위영역 히어로) -->
<link
  rel="preload"
  as="image"
  href="/hero.avif"
  imagesrcset="/hero.avif 1200w, /hero@2x.avif 2400w"
  imagesizes="100vw"
/>
<img
  src="/hero.avif"
  alt="Hero"
  fetchpriority="high"
  width="1280"
  height="720"
/>

<!-- 일반 콘텐츠 이미지 -->
<img
  src="/thumb.webp"
  alt="썸네일"
  loading="lazy"
  decoding="async"
  width="400"
  height="300"
/>
```

## 압축/리사이즈 Sharp Library

Node.js 환경에서 사용할 수 있는 고성능 이미지 처리 라이브러리 입니다. 이미지 업로드, 썸네일 생성, 포맷 변환 등을 서버 단이나 빌드 과정에서 자동화할 때 사용되는데, C로 작성된 엔진 기반으로 압도적인 성능을 자랑합니다.

다른 라이브러리와 달리 이미지 전체를 메모리에 올리지 않고 스트림 방식으로 처리하여 메모리 사용량이 매우 적고 처리속도가 빠릅니다. 최신 CPU의 SIMD(Single Instruction, Multiple Data) 명령어를 활용하여 병렬 처리 성능을 극대화합니다.
