# KMS (Key Management Service)

## 개요

AWS Key Management Service (KMS)는 암호화 키를 생성하고 관리하는 관리형 서비스로, 데이터 암호화 및 암호화 키 관리에 사용됩니다. KMS를 통해 암호화 키의 생성, 저장, 사용, 로테이션을 안전하게 관리합니다.

## 핵심 개념

**SSE(Server-Side Encryption)**는 서버 측 암호화를 의미하며, 데이터가 S3 서버에 저장될 때 자동으로 암호화되는 방식입니다. 클라이언트 측에서 암호화할 필요 없이 S3가 자동으로 암호화를 처리하므로 사용이 간편합니다.

### 암호화 키 유형

**AWS 관리형 키** : AWS가 자동으로 생성하고 관리하는 키로, 특정 AWS 서비스에서 자동으로 사용됩니다. 사용자가 직접 관리할 수 없으며, SSE-S3나 EBS 기본 암호화에서 사용됩니다.

**고객 관리형 키(CMK)** : 사용자가 생성하고 관리하는 키입니다. 키 정책으로 액세스 제어가 가능하고, 키 로테이션을 설정할 수 있으며, 키 사용을 감사할 수 있습니다. SSE-KMS나 RDS 암호화에서 사용되며, 더 세밀한 제어와 감사가 필요한 경우에 적합합니다.

**고객 제공 키**는 사용자가 외부에서 제공하는 키로, AWS 외부에서 키를 관리합니다. S3 SSE-C에서 사용되며, 고객이 키 관리의 완전한 책임을 지는 경우에 사용됩니다.

### 키 정책과 액세스 제어

키 정책은 CMK에 대한 액세스를 제어하는 리소스 정책입니다. 기본 키 정책은 계정 루트 사용자에게 모든 권한을 부여하며, IAM 정책과 함께 사용할 수 있습니다. 키 정책이 IAM 정책보다 우선순위가 높아서, 키 사용을 위해서는 키 정책과 IAM 정책 모두에서 허용되어야 합니다. 키 정책은 CMK에 대한 직접 액세스를 제어하고, IAM 정책은 사용자나 역할의 KMS API 호출 권한을 제어합니다.

### 키 로테이션

키 로테이션은 보안을 강화하기 위해 주기적으로 암호화 키를 교체하는 과정입니다. 자동 로테이션은 연 1회 자동으로 키를 교체하며, 수동 로테이션은 사용자가 직접 새 키를 생성합니다. 중요한 점은 이전 키로 암호화된 데이터는 계속 복호화가 가능하다는 것입니다. 키 로테이션 후에도 이전 키는 유지되어 기존 데이터의 복호화를 보장하며, 새로운 데이터는 새 키로 암호화됩니다.

## 사용 사례

### EBS 볼륨 암호화

EBS(Elastic Block Store)는 EC2 인스턴스에 연결할 수 있는 영구 블록 스토리지 서비스입니다. EBS 볼륨은 가상 하드 디스크와 같은 역할을 하며, 운영 체제, 애플리케이션, 데이터를 저장하는 데 사용됩니다. EBS 볼륨 생성 시 CMK를 지정하여 암호화할 수 있습니다. 스냅샷도 자동으로 암호화되며, 인스턴스 간 볼륨을 복사할 때도 암호화가 유지됩니다. 이를 통해 디스크에 저장된 데이터의 보안을 강화할 수 있습니다.

### RDS 데이터베이스 암호화

RDS 데이터베이스 생성 시 암호화를 활성화할 수 있습니다. 암호화된 스냅샷에서 복원이 가능하며, 읽기 전용 복제본도 암호화할 수 있습니다. 이를 통해 데이터베이스에 저장된 민감한 정보를 보호할 수 있습니다.

### 애플리케이션 레벨 암호화

애플리케이션에서 직접 KMS API를 호출하여 데이터를 암호화하거나 복호화할 수 있습니다. 대용량 데이터의 경우 Envelope Encryption 패턴을 사용하여 성능과 비용을 최적화할 수 있습니다. 이것은 이중 암호화 패턴으로, CMK(마스터 키)로 데이터 키를 암호화하고, 그 데이터 키로 실제 데이터를 암호화하는 방식입니다. 대용량 데이터를 직접 CMK로 암호화하면 매번 KMS API를 호출해야 하므로 비용과 성능에 부담이 됩니다. Envelope Encryption을 사용하면 데이터 키 생성 시에만 CMK를 사용하고, 실제 데이터 암호화는 로컬에서 빠르게 처리할 수 있어 성능과 비용을 최적화할 수 있습니다.

**작동 원리:**

1. CMK로 데이터 키를 생성하고 암호화합니다.
2. 암호화되지 않은 데이터 키로 실제 대용량 데이터를 암호화합니다.
3. 암호화된 데이터 키를 암호화된 데이터와 함께 저장합니다.

**복호화 과정:**

1. CMK를 사용하여 암호화된 데이터 키를 복호화합니다.
2. 복호화된 데이터 키를 사용하여 암호화된 데이터를 복호화합니다.

## 중요 개념

### 비용 구조

CMK 생성과 키 저장은 무료이지만, 키 사용 시 요청당 비용이 발생합니다. 따라서 대용량 데이터를 암호화할 때는 Envelope Encryption 패턴을 사용하여 CMK 호출 횟수를 줄이는 것이 비용 효율적입니다.

### 리전별 독립성

각 리전의 키는 독립적으로 관리됩니다. 리전 간 키 공유가 불가능하므로, 리전 간 데이터를 복사할 때는 재암호화가 필요합니다. 이는 리전별로 다른 키 정책을 적용할 수 있어 보안을 강화할 수 있지만, 리전 간 데이터 이동 시 추가 작업이 필요하다는 점을 고려해야 합니다.

## 모범 사례

### 최소 권한 원칙

키 정책에서 필요한 사용자나 역할만 허용하여 최소 권한 원칙을 적용해야 합니다. 키 사용 권한과 키 관리 권한을 분리하여 관리하면 보안을 강화할 수 있습니다. 예를 들어, 개발자에게는 키 사용 권한만 부여하고 키 삭제나 정책 변경 권한은 관리자에게만 부여할 수 있습니다.

### 키 로테이션 및 모니터링

자동 로테이션을 활성화하여 정기적으로 키를 교체하고, CloudTrail을 통합하여 모든 KMS API 호출을 로깅합니다. 이를 통해 키 사용을 모니터링하고 감사할 수 있습니다. 키 별칭을 사용하면 키 ID 대신 별칭을 사용할 수 있어, 키 로테이션 시에도 별칭은 유지되므로 애플리케이션 코드 변경 없이 키를 교체할 수 있습니다.

### Envelope Encryption 활용

대용량 데이터를 암호화할 때는 Envelope Encryption 패턴을 사용하는 것이 좋습니다. 이 방식은 데이터 키 생성 시에만 CMK를 사용하므로 KMS API 호출 횟수를 크게 줄일 수 있어 성능과 비용을 최적화할 수 있습니다. 특히 대용량 파일이나 스트리밍 데이터를 처리할 때 효과적입니다.

## 관련 서비스

KMS와 관련된 주요 서비스들은 다음과 같습니다. Secrets Manager는 암호화된 시크릿을 저장하는 서비스입니다. CloudHSM은 하드웨어 보안 모듈로, 더 높은 보안 요구사항이 있는 경우 사용됩니다. CloudTrail은 모든 KMS API 호출을 로깅하여 키 사용을 모니터링하고 감사할 수 있게 합니다.
