# Shield & WAF

## 개요
AWS Shield와 AWS WAF는 애플리케이션과 인프라를 보호하는 보안 서비스입니다. Shield는 DDoS 공격으로부터 보호하고, WAF는 웹 애플리케이션 레벨의 공격을 차단합니다.

## AWS Shield

### Shield란?
**정의**: DDoS (Distributed Denial of Service) 공격으로부터 AWS 리소스를 보호하는 관리형 서비스

**DDoS 공격이란?**:
- 다수의 시스템에서 동시에 공격하여 서비스를 사용 불가능하게 만드는 공격
- 대량의 트래픽으로 서버를 과부하시킴
- 정상 사용자가 서비스를 이용할 수 없게 됨

### Shield 유형

#### 1. Shield Standard
**정의**: 모든 AWS 고객에게 자동으로 제공되는 기본 DDoS 보호

**특징**:
- **무료**: 추가 비용 없음
- **자동 활성화**: 모든 AWS 리소스에 자동 적용
- **기본 보호**: 일반적인 DDoS 공격 방어

**보호 대상**:
- CloudFront
- Route 53
- ELB (Elastic Load Balancer)

**보호 수준**:
- 네트워크 레벨 (Layer 3, 4) 공격 방어
- 일반적인 볼륨 기반 공격 차단

#### 2. Shield Advanced
**정의**: 향상된 DDoS 보호 및 전문가 지원

**특징**:
- **유료**: 월 $3,000 (또는 사용량 기반)
- **향상된 보호**: 더 정교한 공격 방어
- **비용 보호**: DDoS 공격으로 인한 확장 비용 보호
- **전문가 지원**: DDoS 대응 팀 지원

**보호 대상**:
- EC2 인스턴스
- ELB
- CloudFront
- Route 53
- Global Accelerator

**추가 기능**:
- **실시간 공격 모니터링**: 공격 패턴 분석
- **비용 보호**: 공격으로 인한 확장 비용 AWS가 부담
- **WAF 통합**: WAF와 함께 사용 시 추가 보호
- **DDoS 대응 팀**: 24/7 전문가 지원

### Shield 작동 원리

**자동 보호**:
```
1. DDoS 공격 감지
2. Shield가 자동으로 공격 트래픽 필터링
3. 정상 트래픽만 리소스에 도달
4. 공격 완화 완료
```

**공격 유형별 대응**:
- **볼륨 기반 공격**: 대량의 트래픽으로 서버 과부하
  → Shield가 공격 트래픽 차단
- **프로토콜 공격**: 네트워크 프로토콜 취약점 악용
  → Shield가 프로토콜 레벨에서 차단
- **애플리케이션 레벨 공격**: 애플리케이션 취약점 악용
  → WAF와 함께 차단

## AWS WAF (Web Application Firewall)

### WAF란?
**정의**: 웹 애플리케이션을 보호하는 방화벽 서비스

**보호 대상**:
- SQL Injection
- Cross-Site Scripting (XSS)
- 지리적 제한
- Rate Limiting
- 커스텀 규칙

### WAF 작동 위치

**배포 옵션**:
1. **CloudFront**: 전역 엣지 위치에 배포
2. **Application Load Balancer (ALB)**: 리전별 배포
3. **API Gateway**: API 엔드포인트 보호
4. **AppSync**: GraphQL API 보호

**작동 흐름**:
```
사용자 요청
  ↓
WAF (규칙 평가)
  ↓
허용 → CloudFront/ALB/API Gateway
거부 → 요청 차단
```

### WAF 구성 요소

#### 1. 웹 ACL (Web Access Control List)
**정의**: WAF 규칙의 컨테이너

**특징**:
- 여러 규칙을 그룹화
- 규칙 평가 순서 정의
- 기본 동작 설정 (Allow/Deny)

#### 2. 규칙 (Rules)
**정의**: 특정 조건에 따라 요청을 허용하거나 거부하는 규칙

**규칙 유형**:

1. **AWS 관리형 규칙**
   - AWS에서 제공하는 사전 구성된 규칙
   - 일반적인 공격 패턴 차단
   - 예: SQL Injection, XSS

2. **AWS Marketplace 규칙**
   - 서드파티 제공 규칙
   - 특수한 보안 요구사항 대응

3. **커스텀 규칙**
   - 사용자가 직접 작성
   - 특정 요구사항에 맞춤

#### 3. 규칙 그룹 (Rule Groups)
**정의**: 관련 규칙들을 그룹화

**용도**:
- 규칙 관리 간소화
- 재사용 가능한 규칙 세트

### WAF 규칙 예시

#### SQL Injection 차단
```json
{
  "Name": "BlockSQLInjection",
  "Priority": 1,
  "Statement": {
    "SqliMatchStatement": {
      "FieldToMatch": {
        "AllQueryArguments": {}
      },
      "TextTransformations": [
        {
          "Priority": 0,
          "Type": "URL_DECODE"
        }
      ]
    }
  },
  "Action": {
    "Block": {}
  }
}
```

#### 지리적 제한
```json
{
  "Name": "BlockSpecificCountries",
  "Priority": 2,
  "Statement": {
    "GeoMatchStatement": {
      "CountryCodes": ["CN", "RU"]
    }
  },
  "Action": {
    "Block": {}
  }
}
```

#### Rate Limiting
```json
{
  "Name": "RateLimit",
  "Priority": 3,
  "Statement": {
    "RateBasedStatement": {
      "Limit": 2000,
      "AggregateKeyType": "IP"
    }
  },
  "Action": {
    "Block": {}
  }
}
```

### WAF 규칙 평가 순서

**평가 흐름**:
```
1. 규칙 우선순위 순서대로 평가
2. 규칙이 일치하면 해당 Action 실행
3. 일치하는 규칙이 없으면 기본 Action 실행
```

**Action 유형**:
- **Allow**: 요청 허용
- **Block**: 요청 차단
- **Count**: 요청 허용하지만 로깅

**예시**:
```
규칙 1 (우선순위 1): SQL Injection 차단 → Block
규칙 2 (우선순위 2): 특정 국가 차단 → Block
규칙 3 (우선순위 3): Rate Limiting → Block
기본 Action: Allow

요청 평가:
- SQL Injection 패턴 발견 → 규칙 1 일치 → Block
- 정상 요청 → 모든 규칙 불일치 → 기본 Action (Allow)
```

## Shield와 WAF 통합

### 통합 사용 시나리오
**목적**: 다층 보안으로 강력한 보호 제공

**구성**:
```
1. Shield Advanced
   - 인프라 레벨 DDoS 보호
   - 네트워크 레벨 공격 차단

2. WAF
   - 애플리케이션 레벨 보호
   - SQL Injection, XSS 등 차단
   - Rate Limiting

3. CloudFront
   - 엣지 위치에서 보호
   - 전 세계 사용자에게 빠른 응답
```

**작동 흐름**:
```
공격 시도
  ↓
Shield: 네트워크 레벨 공격 차단
  ↓
WAF: 애플리케이션 레벨 공격 차단
  ↓
정상 요청만 애플리케이션에 도달
```

## 사용 사례

### 시나리오 1: 웹 애플리케이션 보호
**요구사항**: 
- SQL Injection 공격 차단
- 특정 국가에서의 접근 차단
- Rate Limiting

**구성**:
```
CloudFront
  ↓
WAF (웹 ACL)
  ├── SQL Injection 차단 규칙
  ├── 지리적 제한 규칙
  └── Rate Limiting 규칙
  ↓
ALB
  ↓
EC2 (웹 서버)
```

### 시나리오 2: API 보호
**요구사항**:
- API Gateway 엔드포인트 보호
- Rate Limiting
- IP 화이트리스트

**구성**:
```
API Gateway
  ↓
WAF (웹 ACL)
  ├── Rate Limiting 규칙
  └── IP 화이트리스트 규칙
  ↓
Lambda 함수
```

## 모범 사례

### 1. 다층 보안
- Shield + WAF 조합 사용
- 인프라 레벨 + 애플리케이션 레벨 보호

### 2. 규칙 최적화
- 필요한 규칙만 활성화
- 규칙 우선순위 최적화
- 정기적인 규칙 검토

### 3. 모니터링
- CloudWatch 지표 모니터링
- WAF 로그 분석
- 공격 패턴 파악

### 4. 테스트
- 프로덕션 적용 전 테스트
- 규칙이 정상 트래픽을 차단하지 않는지 확인

### 5. 비용 최적화
- Shield Standard로 시작
- 필요 시 Shield Advanced 업그레이드
- WAF 규칙 수 최적화

## 비용

### Shield Standard
- **무료**: 모든 AWS 고객에게 자동 제공

### Shield Advanced
- **월 $3,000**: 기본 요금
- **또는 사용량 기반**: 데이터 전송량 기반
- **비용 보호**: DDoS 공격으로 인한 확장 비용 AWS 부담

### WAF
- **웹 ACL**: 월 $5
- **규칙**: 규칙당 월 $1
- **요청**: 100만 요청당 $1

## 관련 서비스

### CloudFront
- CDN 서비스
- WAF와 통합
- 엣지 위치에서 보호

### Application Load Balancer
- 로드 밸런서
- WAF와 통합
- 리전별 보호

### API Gateway
- API 관리 서비스
- WAF와 통합
- API 엔드포인트 보호

### CloudWatch
- 모니터링 서비스
- Shield/WAF 지표 수집
- 알람 설정

## 참고 자료
- [Shield 공식 문서](https://docs.aws.amazon.com/shield/)
- [WAF 공식 문서](https://docs.aws.amazon.com/waf/)
- [WAF 규칙 예시](https://docs.aws.amazon.com/waf/latest/developerguide/waf-rules.html)

