# VPC 보안 (보안그룹, NACL)

## 핵심 개념

### 인바운드와 아웃바운드 트래픽

인바운드(Inbound)와 아웃바운드(Outbound) 트래픽은 네트워크 보안에서 중요한 개념입니다. **인바운드 트래픽**은 외부에서 인스턴스나 서브넷으로 들어오는 트래픽을 의미합니다.사용자가 웹 브라우저에서 웹 서버에 접속할 때 발생하는 트래픽이 인바운드 트래픽입니다. **아웃바운드 트래픽**은 인스턴스나 서브넷에서 외부로 나가는 트래픽을 의미합니다. 웹 서버가 데이터베이스에 쿼리를 보내거나, 인스턴스가 인터넷에서 업데이트를 다운로드할 때 발생하는 트래픽이 아웃바운드 트래픽입니다.

보안 그룹과 네트워크 ACL은 모두 인바운드와 아웃바운드 트래픽에 대해 별도의 규칙을 설정할 수 있습니다. 인바운드 규칙은 외부에서 들어오는 트래픽을 제어하고, 아웃바운드 규칙은 내부에서 나가는 트래픽을 제어합니다.

### VPC 기본 구조

VPC(Virtual Private Cloud)는 논리적으로 격리된 네트워크를 제공하며, 이 네트워크 내에서 서브넷을 통해 IP 주소 범위를 정의합니다. 서브넷은 VPC 내의 IP 주소 범위를 나타내며, 각 서브넷은 특정 가용 영역에 속합니다. 인터넷 게이트웨이는 VPC와 인터넷 간의 통신을 가능하게 하며, 라우팅 테이블은 트래픽이 어디로 전달될지를 결정하는 라우팅 규칙을 정의합니다.

### 보안 그룹 (Security Group)

보안 그룹은 인스턴스 레벨의 가상 방화벽으로 작동합니다. 보안 그룹의 가장 중요한 특징은 상태 저장(Stateful) 방식으로 작동한다는 점입니다. 이는 허용된 트래픽의 응답이 자동으로 허용된다는 의미입니다. 보안 그룹은 기본적으로 모든 인바운드 트래픽을 거부하고 모든 아웃바운드 트래픽을 허용합니다. 명시적 허용 규칙만 추가할 수 있으며, 하나의 인스턴스에 여러 보안 그룹을 연결할 수 있습니다.

### 네트워크 ACL (Network Access Control List)

네트워크 ACL은 서브넷 레벨의 방화벽으로 작동합니다. 보안 그룹과 달리 네트워크 ACL은 상태 비저장(Stateless) 방식으로 작동하므로, 인바운드와 아웃바운드 각각에 대해 규칙을 설정해야 합니다. 네트워크 ACL은 기본적으로 모든 트래픽을 허용하며, 명시적 거부 규칙을 추가할 수 있습니다. 규칙 번호로 우선순위가 결정되며, 낮은 번호가 높은 우선순위를 가집니다.

## 비교표

| 항목      | 보안 그룹                      | 네트워크 ACL      |
| --------- | ------------------------------ | ----------------- |
| 레벨      | 인스턴스 레벨                  | 서브넷 레벨       |
| 상태      | 상태 저장                      | 상태 비저장       |
| 기본 규칙 | 인바운드 거부, 아웃바운드 허용 | 모든 트래픽 허용  |
| 규칙      | 허용만 가능                    | 허용 및 거부 가능 |
| 연결      | 여러 보안 그룹 연결 가능       | 서브넷당 하나     |

## 사용 사례

### 보안 그룹 사용

보안 그룹은 EC2 인스턴스의 세밀한 액세스 제어에 주로 사용됩니다. 웹 서버의 경우 포트 80(HTTP)과 443(HTTPS)만 인바운드로 허용하여 웹 트래픽만 받아들이도록 설정할 수 있습니다. 데이터베이스의 경우 특정 보안 그룹에서만 접근을 허용하여, 웹 서버 보안 그룹에서만 데이터베이스 포트로의 접근을 허용하는 방식으로 보안을 강화할 수 있습니다.

### 네트워크 ACL 사용

네트워크 ACL은 서브넷 레벨의 추가 보안 계층을 제공합니다. 특정 IP 범위를 차단하거나, DDoS 공격을 서브넷 레벨에서 방어하는 데 사용됩니다. 네트워크 ACL은 서브넷 전체에 적용되므로, 서브넷 내의 모든 인스턴스에 일괄적으로 보안 규칙을 적용할 수 있습니다.

### 1. 상태 저장 (Stateful) vs 상태 비저장 (Stateless)

#### 보안 그룹: 상태 저장 (Stateful)

보안 그룹은 연결 상태를 추적하여 응답 트래픽을 자동으로 허용하는 상태 저장 방식으로 작동합니다. 작동 원리를 설명하면, 먼저 인바운드 규칙으로 포트 80을 허용합니다. 사용자가 웹 서버에 요청을 보내면(인바운드), 웹 서버가 응답을 보냅니다(아웃바운드). 이때 보안 그룹이 연결 상태를 기억하고 있어서, 응답 트래픽이 자동으로 허용됩니다. 따라서 아웃바운드 규칙을 명시적으로 설정하지 않아도 됩니다.

예를 들어, 인바운드 규칙에 포트 80(HTTP)만 허용하면, 아웃바운드 규칙을 별도로 설정하지 않아도 HTTP 응답 트래픽은 자동으로 허용됩니다. 이 방식의 장점은 규칙 관리가 간소화되고, 응답 트래픽을 별도로 허용할 필요가 없다는 것입니다.

#### 네트워크 ACL: 상태 비저장 (Stateless)

네트워크 ACL은 각 패킷을 독립적으로 평가하며 연결 상태를 추적하지 않는 상태 비저장 방식으로 작동합니다. 작동 원리를 설명하면, 인바운드 규칙으로 포트 80을 허용합니다. 사용자가 웹 서버에 요청을 보내면(인바운드), 웹 서버가 응답을 보냅니다(아웃바운드). 하지만 NACL은 연결 상태를 기억하지 않기 때문에, 아웃바운드 규칙이 없으면 응답이 거부됩니다.

예를 들어, 인바운드 규칙에 포트 80(HTTP 요청)을 허용했다면, 아웃바운드 규칙에도 포트 1024-65535 범위를 허용해야 HTTP 응답이 가능합니다. 이는 일시적 포트(ephemeral ports) 범위를 고려해야 하기 때문입니다. 일시적 포트는 클라이언트가 서버에 연결할 때 사용하는 임시 포트로, 일반적으로 1024-65535 범위이며 서버는 이 포트로 응답을 보냅니다. 따라서 네트워크 ACL을 사용할 때는 인바운드와 아웃바운드를 각각 설정해야 하며, 일시적 포트 범위를 고려해야 합니다.

### 2. 트래픽 평가 순서

트래픽이 인스턴스에 도달하고 나가는 과정에서 평가되는 순서는 다음과 같습니다. 먼저 네트워크 ACL의 인바운드 규칙이 평가되고, 그 다음 보안 그룹의 인바운드 규칙이 평가됩니다. 모든 규칙을 통과하면 인스턴스에 도달합니다. 인스턴스에서 나가는 트래픽은 먼저 보안 그룹의 아웃바운드 규칙이 평가되고, 마지막으로 네트워크 ACL의 아웃바운드 규칙이 평가됩니다.

중요한 점은 모든 단계에서 허용되어야 트래픽이 통과한다는 것입니다. 예를 들어, 인바운드 HTTP 요청의 경우 NACL 인바운드 규칙에서 허용되고, 보안 그룹 인바운드 규칙에서도 허용되어야 인스턴스에 도달할 수 있습니다. 응답 트래픽의 경우 보안 그룹은 상태 저장 방식이므로 자동으로 허용되지만, NACL은 상태 비저장 방식이므로 아웃바운드 규칙에서 명시적으로 허용되어야 합니다.

### 3. 기본 규칙의 차이

보안 그룹과 네트워크 ACL의 기본 규칙은 서로 다릅니다. 보안 그룹은 기본적으로 모든 인바운드 트래픽을 거부하고 모든 아웃바운드 트래픽을 허용합니다. 이는 기본적으로 차단되어 있어 보안이 강화되며, 필요한 트래픽만 명시적으로 허용할 수 있다는 보안상 이점이 있습니다.

반면 네트워크 ACL은 기본적으로 모든 인바운드와 아웃바운드 트래픽을 모두 허용합니다. 이는 기본적으로 열려있어 보안이 취약할 수 있으므로, 필요한 제한을 명시적으로 추가해야 합니다. 네트워크 ACL을 사용할 때는 보안 그룹과 함께 사용하여 계층적 보안을 구현하는 것이 좋습니다.

### 4. 다중 보안 그룹

하나의 인스턴스에 여러 보안 그룹을 연결할 수 있으며, 모든 보안 그룹의 규칙이 OR 조건으로 결합됩니다. 즉, 하나의 보안 그룹에서 허용하면 트래픽이 통과합니다. 예를 들어, 인스턴스에 보안 그룹 A(포트 80 허용)와 보안 그룹 B(포트 443 허용)를 연결하면, 포트 80과 443 모두 허용됩니다.

이 기능은 역할별로 보안 그룹을 분리하거나, 웹 서버 그룹과 관리 그룹을 조합하여 사용할 때 유용합니다. 각 역할이나 기능에 맞는 보안 그룹을 만들고, 필요한 인스턴스에 조합하여 적용할 수 있습니다.

### 5. NACL 규칙 번호

네트워크 ACL의 규칙 번호는 우선순위를 결정하며, 낮은 번호가 높은 우선순위를 가집니다. 규칙 번호는 고유해야 합니다. 예를 들어, 규칙 번호 100으로 포트 80을 허용하고 규칙 번호 200으로 모든 트래픽을 거부하면, 포트 80은 100번 규칙이 먼저 평가되어 허용되고, 다른 포트는 200번 규칙이 적용되어 거부됩니다.

모범 사례는 규칙 번호를 100 단위로 할당하는 것입니다(예: 100, 200, 300). 이렇게 하면 나중에 중간에 규칙을 추가할 수 있어 유연성이 향상됩니다.

### 6. 보안 그룹 참조

보안 그룹은 다른 보안 그룹을 소스나 대상으로 지정할 수 있습니다. 예를 들어, 웹 서버 보안 그룹의 인바운드 규칙에 ALB 보안 그룹에서 포트 8080을 허용하도록 설정할 수 있습니다. 또한 데이터베이스 보안 그룹의 인바운드 규칙에 웹 서버 보안 그룹에서 포트 3306을 허용하도록 설정할 수 있습니다.

이 기능의 장점은 IP 주소가 변경되어도 자동으로 적용된다는 점입니다. 동적 IP 환경에서 특히 유용하며, 보안 그룹 간의 의존성을 명확하게 표현할 수 있습니다.

### 3-Tier 아키텍처

```
인터넷
  ↓
인터넷 게이트웨이
  ↓
퍼블릭 서브넷 (ALB)
  ↓
프라이빗 서브넷 (EC2)
  ↓
데이터베이스 서브넷 (RDS)
```

## 관련 서비스

VPC 보안과 관련된 주요 서비스들은 다음과 같습니다. VPC는 가상 네트워크를 제공하며, NAT Gateway는 프라이빗 서브넷의 아웃바운드 인터넷 접근을 가능하게 합니다. VPC Flow Logs는 네트워크 트래픽을 로깅하여 보안 모니터링과 분석을 가능하게 하며, WAF(Web Application Firewall)는 Layer 7 레벨에서 웹 애플리케이션을 보호하는 방화벽입니다.
