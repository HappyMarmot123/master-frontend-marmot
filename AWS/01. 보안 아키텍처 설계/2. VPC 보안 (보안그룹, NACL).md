# VPC 보안 (보안그룹, NACL)

## 개요
VPC (Virtual Private Cloud)는 AWS 클라우드에서 논리적으로 격리된 네트워크를 제공합니다. 보안 그룹과 네트워크 ACL을 통해 네트워크 레벨의 보안을 구현합니다.

## 핵심 개념

### VPC 기본 구조
- **VPC**: 논리적으로 격리된 네트워크
- **서브넷**: VPC 내의 IP 주소 범위
- **인터넷 게이트웨이**: VPC와 인터넷 간 통신
- **라우팅 테이블**: 트래픽 라우팅 규칙

### 보안 그룹 (Security Group)
- **정의**: 인스턴스 레벨의 가상 방화벽
- **특징**:
  - 상태 저장 (Stateful): 허용된 트래픽의 응답은 자동 허용
  - 기본적으로 모든 인바운드 트래픽 거부
  - 기본적으로 모든 아웃바운드 트래픽 허용
  - 명시적 허용 규칙만 추가 가능
  - 인스턴스에 여러 보안 그룹 연결 가능

### 네트워크 ACL (Network ACL)
- **정의**: 서브넷 레벨의 방화벽
- **특징**:
  - 상태 비저장 (Stateless): 인바운드/아웃바운드 각각 규칙 필요
  - 기본적으로 모든 트래픽 허용
  - 명시적 거부 규칙 추가 가능
  - 규칙 번호로 우선순위 결정 (낮은 번호가 우선)

## 비교표

| 항목 | 보안 그룹 | 네트워크 ACL |
|------|-----------|--------------|
| 레벨 | 인스턴스 레벨 | 서브넷 레벨 |
| 상태 | 상태 저장 | 상태 비저장 |
| 기본 규칙 | 인바운드 거부, 아웃바운드 허용 | 모든 트래픽 허용 |
| 규칙 | 허용만 가능 | 허용 및 거부 가능 |
| 연결 | 여러 보안 그룹 연결 가능 | 서브넷당 하나 |

## 사용 사례

### 보안 그룹 사용
- EC2 인스턴스의 세밀한 액세스 제어
- 웹 서버: 포트 80, 443 허용
- 데이터베이스: 특정 보안 그룹에서만 접근 허용

### 네트워크 ACL 사용
- 서브넷 레벨의 추가 보안 계층
- 특정 IP 범위 차단
- DDoS 공격 방어 (서브넷 레벨)

## 중요 개념

### 1. 상태 저장 (Stateful) vs 상태 비저장 (Stateless)

#### 보안 그룹: 상태 저장 (Stateful)
**정의**: 연결 상태를 추적하여 응답 트래픽을 자동으로 허용

**작동 원리**:
```
1. 인바운드 규칙: 포트 80 허용
2. 사용자가 웹 서버에 요청 (인바운드)
3. 웹 서버가 응답 (아웃바운드)
4. 보안 그룹이 연결 상태를 기억
5. 응답 트래픽 자동 허용 (아웃바운드 규칙 불필요)
```

**예시**:
```
인바운드 규칙:
- 포트 80 허용 (HTTP)

아웃바운드 규칙:
- 명시적으로 설정하지 않아도 됨
- 응답 트래픽은 자동 허용
```

**장점**:
- 규칙 관리 간소화
- 응답 트래픽을 별도로 허용할 필요 없음

#### 네트워크 ACL: 상태 비저장 (Stateless)
**정의**: 각 패킷을 독립적으로 평가, 연결 상태를 추적하지 않음

**작동 원리**:
```
1. 인바운드 규칙: 포트 80 허용
2. 사용자가 웹 서버에 요청 (인바운드)
3. 웹 서버가 응답 (아웃바운드)
4. NACL이 연결 상태를 기억하지 않음
5. 아웃바운드 규칙이 없으면 응답 거부
```

**예시**:
```
인바운드 규칙:
- 포트 80 허용 (HTTP 요청)

아웃바운드 규칙:
- 포트 1024-65535 허용 (HTTP 응답)
- 명시적으로 설정해야 함
```

**주의사항**:
- 인바운드와 아웃바운드를 각각 설정해야 함
- 일시적 포트(ephemeral ports) 범위 고려 필요

**일시적 포트란?**:
- 클라이언트가 서버에 연결할 때 사용하는 임시 포트
- 일반적으로 1024-65535 범위
- 서버는 이 포트로 응답을 보냄

### 2. 트래픽 평가 순서

**평가 순서**:
```
1. 네트워크 ACL (인바운드)
   ↓
2. 보안 그룹 (인바운드)
   ↓
3. 인스턴스에 도달
   ↓
4. 보안 그룹 (아웃바운드)
   ↓
5. 네트워크 ACL (아웃바운드)
```

**중요**: 모든 단계에서 허용되어야 트래픽이 통과합니다.

**예시**:
```
인바운드 HTTP 요청:
1. NACL 인바운드 규칙 확인 → 허용
2. 보안 그룹 인바운드 규칙 확인 → 허용
3. 인스턴스에 도달
4. 보안 그룹 아웃바운드 규칙 확인 → 자동 허용 (Stateful)
5. NACL 아웃바운드 규칙 확인 → 허용되어야 함 (Stateless)
```

### 3. 기본 규칙의 차이

#### 보안 그룹 기본 규칙
- **인바운드**: 모든 트래픽 거부 (명시적 허용 필요)
- **아웃바운드**: 모든 트래픽 허용

**보안상 이점**:
- 기본적으로 차단되어 있어 보안 강화
- 필요한 트래픽만 명시적으로 허용

#### 네트워크 ACL 기본 규칙
- **인바운드**: 모든 트래픽 허용
- **아웃바운드**: 모든 트래픽 허용

**주의사항**:
- 기본적으로 열려있어 보안 취약
- 필요한 제한을 명시적으로 추가해야 함

### 4. 다중 보안 그룹

**작동 원리**:
- 인스턴스에 여러 보안 그룹을 연결할 수 있음
- 모든 보안 그룹의 규칙이 **OR 조건**으로 결합
- 하나의 보안 그룹에서 허용하면 통과

**예시**:
```
인스턴스에 연결된 보안 그룹:
- 보안 그룹 A: 포트 80 허용
- 보안 그룹 B: 포트 443 허용

결과:
- 포트 80과 443 모두 허용 (OR 조건)
```

**사용 사례**:
- 역할별로 보안 그룹 분리
- 웹 서버 그룹 + 관리 그룹 조합

### 5. NACL 규칙 번호

**우선순위**:
- 낮은 번호가 높은 우선순위
- 규칙 번호는 고유해야 함

**예시**:
```
규칙 번호 100: 포트 80 허용
규칙 번호 200: 모든 트래픽 거부

→ 포트 80은 허용 (100번 규칙이 먼저 평가)
→ 다른 포트는 거부 (200번 규칙 적용)
```

**모범 사례**:
- 규칙 번호를 100 단위로 할당 (예: 100, 200, 300)
- 나중에 중간에 규칙 추가 가능

### 6. 보안 그룹 참조

**기능**: 다른 보안 그룹을 소스/대상으로 지정 가능

**예시**:
```
웹 서버 보안 그룹:
- 인바운드: ALB 보안 그룹에서 포트 8080 허용

데이터베이스 보안 그룹:
- 인바운드: 웹 서버 보안 그룹에서 포트 3306 허용
```

**장점**:
- IP 주소가 변경되어도 자동으로 적용
- 동적 IP 환경에서 유용
- 보안 그룹 간 의존성 명확히 표현

## 모범 사례

1. **최소 권한 원칙**
   - 필요한 포트와 프로토콜만 허용
   - 특정 IP 범위 또는 보안 그룹에서만 접근 허용

2. **계층적 보안**
   - 보안 그룹 + NACL 조합 사용
   - 서브넷 분리 (퍼블릭/프라이빗)

3. **네트워크 분할**
   - 퍼블릭 서브넷: 인터넷 접근 가능
   - 프라이빗 서브넷: 인터넷 접근 불가 (NAT Gateway 통해서만)
   - 데이터베이스 서브넷: 완전 격리

4. **보안 그룹 참조**
   - 다른 보안 그룹을 소스/대상으로 지정 가능
   - 동적 IP 변경에 대응 가능

## 네트워크 아키텍처 예시

### 3-Tier 아키텍처
```
인터넷
  ↓
인터넷 게이트웨이
  ↓
퍼블릭 서브넷 (ALB)
  ↓
프라이빗 서브넷 (EC2)
  ↓
데이터베이스 서브넷 (RDS)
```

### 보안 그룹 구성 예시
- **ALB 보안 그룹**: 포트 80, 443 인바운드 허용
- **EC2 보안 그룹**: ALB 보안 그룹에서만 포트 8080 허용
- **RDS 보안 그룹**: EC2 보안 그룹에서만 포트 3306 허용

## 관련 서비스
- **VPC**: 가상 네트워크
- **NAT Gateway**: 프라이빗 서브넷의 아웃바운드 인터넷 접근
- **VPC Flow Logs**: 네트워크 트래픽 로깅
- **WAF**: 웹 애플리케이션 방화벽 (Layer 7)

## 참고 자료
- [VPC 공식 문서](https://docs.aws.amazon.com/vpc/)
- [보안 그룹](https://docs.aws.amazon.com/vpc/latest/userguide/security-groups.html)
- [네트워크 ACL](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html)

