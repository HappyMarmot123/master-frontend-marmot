# STS (Security Token Service)

## 개요
AWS Security Token Service (STS)는 AWS 리소스에 대한 임시 보안 자격 증명을 요청하고 제공하는 웹 서비스입니다. 영구 자격 증명 대신 임시 자격 증명을 사용하여 보안을 강화할 수 있습니다.

## 핵심 개념

### STS란?
**정의**: 임시 보안 자격 증명을 발급하는 AWS 서비스

**임시 자격 증명의 구성 요소**:
- **액세스 키 ID**: 임시 액세스 키
- **시크릿 액세스 키**: 임시 시크릿 키
- **세션 토큰**: 세션을 식별하는 토큰
- **만료 시간**: 자격 증명이 유효한 기간

**영구 자격 증명 vs 임시 자격 증명**:

| 항목 | 영구 자격 증명 | 임시 자격 증명 |
|------|---------------|---------------|
| **만료** | 없음 | 기본 1시간, 최대 12시간 |
| **보안** | 낮음 (유출 시 계속 사용 가능) | 높음 (만료되면 무효화) |
| **관리** | 수동 로테이션 필요 | 자동 만료 및 갱신 |
| **사용 사례** | 장기적인 프로그래밍 접근 | 역할 기반 접근, 교차 계정 |

## STS 주요 API 작업

### 1. AssumeRole
**정의**: IAM 역할을 가정하여 임시 자격 증명 획득

**사용 사례**:
- EC2 인스턴스가 S3에 접근
- Lambda 함수가 다른 서비스 호출
- 교차 계정 액세스
- 애플리케이션이 다른 계정의 리소스 접근

**요청 예시**:
```json
{
  "RoleArn": "arn:aws:iam::123456789012:role/S3AccessRole",
  "RoleSessionName": "MySession",
  "DurationSeconds": 3600
}
```

**응답 예시**:
```json
{
  "Credentials": {
    "AccessKeyId": "ASIAIOSFODNN7EXAMPLE",
    "SecretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
    "SessionToken": "FQoGZXIvYXdzE...",
    "Expiration": "2024-01-01T12:00:00Z"
  }
}
```

### 2. AssumeRoleWithSAML
**정의**: SAML 어설션을 사용하여 역할 가정

**사용 사례**:
- 페더레이션된 사용자가 AWS 리소스 접근
- 엔터프라이즈 SSO 환경
- Active Directory와 통합

**작동 흐름**:
```
1. 사용자가 ID 공급자에서 인증
2. ID 공급자가 SAML 어설션 생성
3. 애플리케이션이 AssumeRoleWithSAML 호출 (SAML 어설션 포함)
4. STS가 어설션 검증
5. 임시 자격 증명 발급
```

### 3. AssumeRoleWithWebIdentity
**정의**: 웹 ID 토큰(예: OIDC 토큰)을 사용하여 역할 가정

**사용 사례**:
- 모바일 애플리케이션
- 웹 애플리케이션
- Google, Facebook 등 소셜 로그인

**작동 흐름**:
```
1. 사용자가 Google/Facebook에서 로그인
2. ID 공급자가 ID 토큰 발급
3. 애플리케이션이 AssumeRoleWithWebIdentity 호출 (ID 토큰 포함)
4. STS가 토큰 검증
5. 임시 자격 증명 발급
```

### 4. GetSessionToken
**정의**: MFA가 활성화된 사용자의 임시 자격 증명 획득

**사용 사례**:
- MFA가 필요한 작업 수행
- 장기 실행 작업 (임시 자격 증명 만료 전)

**특징**:
- 사용자 자격 증명 필요
- MFA 토큰 필요 (MFA 활성화된 경우)
- 최대 36시간 유효

### 5. GetFederationToken
**정의**: 페더레이션된 사용자의 임시 자격 증명 획득

**사용 사례**:
- 커스텀 페더레이션 솔루션
- 임시 사용자 자격 증명 필요

**특징**:
- 사용자 이름 지정 가능
- 정책 제한 가능
- 최대 36시간 유효

## 역할 전환 (AssumeRole) 상세

### 역할 신뢰 정책 (Trust Policy)
**정의**: 어떤 주체(Principal)가 역할을 가정할 수 있는지 정의하는 정책

**예시**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::111111111111:user/developer"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "unique-external-id-12345"
        }
      }
    }
  ]
}
```

**주요 Principal 유형**:
- **AWS 사용자**: `"AWS": "arn:aws:iam::ACCOUNT:user/USERNAME"`
- **AWS 역할**: `"AWS": "arn:aws:iam::ACCOUNT:role/ROLENAME"`
- **AWS 서비스**: `"Service": "ec2.amazonaws.com"`
- **다른 계정**: `"AWS": "arn:aws:iam::ACCOUNT:root"`

### 외부 ID (External ID)
**정의**: 교차 계정 액세스 시 보안을 강화하기 위한 선택적 파라미터

**왜 필요한가?**:
- 역할 ARN을 알고 있어도 역할을 가정할 수 없도록 함
- 외부 ID를 모르면 역할 가정 불가
- "Confused Deputy" 문제 방지

**작동 원리**:
```
1. 역할 신뢰 정책에 External ID 조건 추가
2. AssumeRole 호출 시 External ID 제공 필요
3. 제공된 External ID가 정책의 조건과 일치해야 함
4. 일치하지 않으면 역할 가정 실패
```

**예시**:
```json
// 역할 신뢰 정책
{
  "Condition": {
    "StringEquals": {
      "sts:ExternalId": "unique-external-id-12345"
    }
  }
}

// AssumeRole 호출
{
  "RoleArn": "arn:aws:iam::123456789012:role/CrossAccountRole",
  "RoleSessionName": "MySession",
  "ExternalId": "unique-external-id-12345"  // 필수
}
```

### 세션 태그 (Session Tags)
**정의**: 역할 세션에 메타데이터를 추가하는 기능

**용도**:
- 세션 추적
- 비용 할당
- 감사 및 규정 준수

**예시**:
```json
{
  "RoleArn": "arn:aws:iam::123456789012:role/S3AccessRole",
  "RoleSessionName": "MySession",
  "Tags": [
    {
      "Key": "Project",
      "Value": "DataMigration"
    },
    {
      "Key": "Environment",
      "Value": "Production"
    }
  ]
}
```

## 교차 계정 액세스

### 시나리오
계정 A의 사용자가 계정 B의 S3 버킷에 접근해야 함

### 구성 단계

1. **계정 B에서 역할 생성**
   ```json
   역할 이름: CrossAccountS3AccessRole
   신뢰 정책: 계정 A의 사용자/역할 신뢰
   권한 정책: S3 읽기/쓰기 권한
   ```

2. **계정 A의 사용자가 역할 가정**
   ```python
   import boto3
   
   sts_client = boto3.client('sts')
   
   response = sts_client.assume_role(
       RoleArn='arn:aws:iam::222222222222:role/CrossAccountS3AccessRole',
       RoleSessionName='CrossAccountSession',
       ExternalId='unique-external-id-12345'
   )
   
   credentials = response['Credentials']
   ```

3. **임시 자격 증명으로 S3 접근**
   ```python
   s3_client = boto3.client(
       's3',
       aws_access_key_id=credentials['AccessKeyId'],
       aws_secret_access_key=credentials['SecretAccessKey'],
       aws_session_token=credentials['SessionToken']
   )
   
   # 계정 B의 S3 버킷 접근
   s3_client.list_buckets()
   ```

### 보안 고려사항

1. **외부 ID 사용**: 교차 계정 액세스 시 반드시 사용
2. **최소 권한 원칙**: 필요한 권한만 부여
3. **세션 시간 제한**: 가능한 짧은 세션 시간 설정
4. **정기적인 감사**: CloudTrail로 역할 가정 활동 모니터링

## EC2 인스턴스 역할

### 작동 원리
EC2 인스턴스에 IAM 역할을 연결하면, 인스턴스가 자동으로 역할을 가정합니다.

**과정**:
```
1. EC2 인스턴스 시작 시 IAM 역할 연결
2. 인스턴스 메타데이터 서비스(IMDS)를 통해 임시 자격 증명 요청
3. IMDS가 STS AssumeRole을 호출
4. 임시 자격 증명 반환
5. 애플리케이션이 AWS SDK를 통해 자동으로 자격 증명 사용
```

**코드 예시**:
```python
# EC2 인스턴스에서 실행되는 코드
# 별도의 자격 증명 설정 불필요
import boto3

# AWS SDK가 자동으로 인스턴스 역할의 자격 증명 사용
s3_client = boto3.client('s3')
s3_client.list_buckets()  # 역할에 부여된 권한으로 접근
```

**장점**:
- 액세스 키를 코드나 환경 변수에 저장할 필요 없음
- 자동으로 자격 증명 교체 (만료 시 자동 갱신)
- 보안 강화

## Lambda 실행 역할

### 작동 원리
Lambda 함수에 실행 역할을 연결하면, 함수 실행 시 자동으로 역할을 가정합니다.

**과정**:
```
1. Lambda 함수 생성 시 실행 역할 지정
2. 함수 실행 시 Lambda 서비스가 역할 가정
3. 함수 코드가 AWS SDK를 통해 자동으로 자격 증명 사용
```

**코드 예시**:
```python
# Lambda 함수 코드
import boto3

def lambda_handler(event, context):
    # 실행 역할의 자격 증명 자동 사용
    dynamodb = boto3.client('dynamodb')
    dynamodb.scan(TableName='MyTable')
    return {'statusCode': 200}
```

## 임시 자격 증명 만료 처리

### 만료 시간
- **기본**: 1시간
- **최대**: 12시간 (역할 설정에서 변경 가능)
- **GetSessionToken/GetFederationToken**: 최대 36시간

### 자동 갱신
일부 AWS SDK는 자동으로 자격 증명을 갱신합니다:
- **EC2 인스턴스 역할**: IMDS가 자동 갱신
- **Lambda 실행 역할**: Lambda 서비스가 자동 갱신
- **애플리케이션**: 수동으로 AssumeRole 다시 호출 필요

### 만료 처리 예시
```python
import boto3
from datetime import datetime, timedelta

def get_credentials():
    sts = boto3.client('sts')
    response = sts.assume_role(
        RoleArn='arn:aws:iam::123456789012:role/MyRole',
        RoleSessionName='MySession',
        DurationSeconds=3600
    )
    return response['Credentials']

def check_expiration(credentials):
    expiration = credentials['Expiration']
    now = datetime.utcnow().replace(tzinfo=expiration.tzinfo)
    time_until_expiration = expiration - now
    
    # 5분 전에 갱신
    if time_until_expiration < timedelta(minutes=5):
        return True
    return False

# 사용 예시
credentials = get_credentials()
if check_expiration(credentials):
    credentials = get_credentials()  # 갱신
```

## 보안 모범 사례

### 1. 최소 권한 원칙
- 역할에 필요한 최소한의 권한만 부여
- 정기적으로 권한 검토

### 2. 세션 시간 제한
- 가능한 짧은 세션 시간 설정
- 장기 실행 작업은 세션 갱신

### 3. 외부 ID 사용
- 교차 계정 액세스 시 반드시 사용
- 고유하고 예측 불가능한 값 사용

### 4. 세션 태그 활용
- 세션 추적 및 감사
- 비용 할당

### 5. 모니터링
- CloudTrail로 모든 STS API 호출 로깅
- 비정상적인 역할 가정 활동 감지

## 관련 서비스

### IAM
- 역할 생성 및 관리
- 권한 정책 정의

### CloudTrail
- STS API 호출 로깅
- 역할 가정 활동 추적

### IAM Identity Center
- 페더레이션된 사용자 역할 가정
- SAML 기반 역할 가정

## 실제 사용 사례

### 시나리오 1: EC2에서 S3 접근
```
1. S3 읽기/쓰기 권한을 가진 IAM 역할 생성
2. EC2 인스턴스에 역할 연결
3. 인스턴스에서 실행되는 애플리케이션이 자동으로 S3 접근
4. 액세스 키 저장 불필요
```

### 시나리오 2: 교차 계정 백업
```
계정 A: 프로덕션 계정
계정 B: 백업 계정

1. 계정 B에 백업 역할 생성 (S3 쓰기 권한)
2. 계정 A의 Lambda 함수가 역할 가정
3. 프로덕션 데이터를 계정 B의 S3 버킷에 백업
```

### 시나리오 3: 페더레이션된 사용자 접근
```
1. 사용자가 회사 Active Directory로 로그인
2. 애플리케이션이 SAML 어설션 획득
3. AssumeRoleWithSAML 호출
4. 임시 자격 증명으로 AWS 리소스 접근
```

## 참고 자료
- [STS 공식 문서](https://docs.aws.amazon.com/STS/latest/APIReference/)
- [역할 전환 가이드](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use.html)
- [교차 계정 액세스](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_aws-accounts.html)

