# STS (Security Token Service)

## 개요

AWS Security Token Service (STS)는 리소스에 대한 임시 보안 자격 증명을 요청하고 제공하는 웹 서비스입니다. 영구 자격 증명 대신 임시 자격 증명을 사용하여 보안을 강화할 수 있습니다.

**영구 자격 증명 vs 임시 자격 증명**:

| 항목          | 영구 자격 증명                | 임시 자격 증명            |
| ------------- | ----------------------------- | ------------------------- |
| **만료**      | 없음                          | 기본 1시간, 최대 12시간   |
| **보안**      | 낮음 (유출 시 계속 사용 가능) | 높음 (만료되면 무효화)    |
| **관리**      | 수동 로테이션 필요            | 자동 만료 및 갱신         |
| **사용 사례** | 장기적인 프로그래밍 접근      | 역할 기반 접근, 교차 계정 |

## STS 주요 API 작업

### 1. AssumeRole

AssumeRole은 IAM 역할을 가정하여 임시 자격 증명을 획득하는 API입니다. EC2 인스턴스가 S3에 접근하거나, Lambda 함수가 다른 서비스를 호출하거나, 교차 계정 액세스가 필요하거나, 애플리케이션이 다른 계정의 리소스에 접근해야 할 때 사용됩니다.

**요청 예시**:

```json
{
  "RoleArn": "arn:aws:iam::123456789012:role/S3AccessRole",
  "RoleSessionName": "MySession",
  "DurationSeconds": 3600
}
```

**응답 예시**:

```json
{
  "Credentials": {
    "AccessKeyId": "ASIAIOSFODNN7EXAMPLE",
    "SecretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
    "SessionToken": "FQoGZXIvYXdzE...",
    "Expiration": "2024-01-01T12:00:00Z"
  }
}
```

### 2. AssumeRoleWithSAML

AssumeRoleWithSAML은 SAML 어설션을 사용하여 역할을 가정하는 API입니다. 페더레이션된 사용자가 AWS 리소스에 접근하거나, 엔터프라이즈 SSO 환경에서 사용되며, Active Directory와 통합된 환경에서 활용됩니다.

### 3. AssumeRoleWithWebIdentity

AssumeRoleWithWebIdentity는 웹 ID 토큰(예: OIDC 토큰)을 사용하여 역할을 가정하는 API입니다. 모바일 또는 웹앱에서 사용되며, 소셜 로그인과 통합할 때 활용됩니다.

### 4. GetSessionToken

GetSessionToken은 MFA가 활성화된 사용자의 임시 자격 증명을 획득하는 API입니다. MFA가 필요한 작업을 수행하거나 장기 실행 작업을 수행할 때 임시 자격 증명이 만료되기 전에 사용됩니다. 이 API는 사용자 자격 증명이 필요하며, MFA가 활성화된 경우 MFA 토큰이 필요합니다. 최대 36시간까지 유효합니다.

### 5. GetFederationToken

GetFederationToken은 페더레이션된 사용자의 임시 자격 증명을 획득하는 API입니다. 커스텀 페더레이션 솔루션이나 임시 사용자 자격 증명이 필요한 경우에 사용됩니다. 이 API는 사용자 이름을 지정할 수 있고 정책을 제한할 수 있으며, 최대 36시간까지 유효합니다.

## 역할 전환 (AssumeRole) 상세

### 역할 신뢰 정책 (Trust Policy)

**정의**: 어떤 주체(Principal)가 역할을 가정할 수 있는지 정의하는 정책

**ARN(Amazon Resource Name)**은 AWS 리소스를 고유하게 식별하는 이름입니다. ARN 형식은 `arn:aws:서비스:리전:계정ID:리소스타입/리소스이름`으로 구성되며, 예를 들어 `arn:aws:iam::123456789012:role/S3AccessRole`은 IAM 역할을 식별하는 ARN입니다. ARN을 통해 AWS 계정, 리전, 서비스, 리소스 타입, 리소스 이름을 모두 포함하여 리소스를 정확하게 지정할 수 있습니다.

**예시**:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::111111111111:user/developer"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "unique-external-id-12345"
        }
      }
    }
  ]
}
```

**주요 Principal 유형**: 역할 신뢰 정책에서 사용할 수 있는 주요 Principal 유형은 AWS 사용자(`"AWS": "arn:aws:iam::ACCOUNT:user/USERNAME"`), AWS 역할(`"AWS": "arn:aws:iam::ACCOUNT:role/ROLENAME"`), AWS 서비스(`"Service": "ec2.amazonaws.com"`), 다른 계정(`"AWS": "arn:aws:iam::ACCOUNT:root"`) 등이 있습니다.

### 외부 ID (External ID)

외부 ID는 교차 계정 액세스 시 보안을 강화하기 위한 선택적 파라미터입니다. 외부 ID가 필요한 이유는 역할 ARN을 알고 있어도 역할을 가정할 수 없도록 하기 위함입니다. 외부 ID를 모르면 역할 가정이 불가능하며, 이를 통해 "Confused Deputy" 문제를 방지할 수 있습니다.

**예시**:

```json
// 역할 신뢰 정책
{
  "Condition": {
    "StringEquals": {
      "sts:ExternalId": "unique-external-id-12345"
    }
  }
}

// AssumeRole 호출
{
  "RoleArn": "arn:aws:iam::123456789012:role/CrossAccountRole",
  "RoleSessionName": "MySession",
  "ExternalId": "unique-external-id-12345"  // 필수
}
```

### 세션 태그 (Session Tags)

세션 태그는 역할 세션에 메타데이터를 추가하는 기능입니다. 세션 추적, 비용 할당, 감사 및 규정 준수 등의 용도로 사용됩니다.

**예시**:

```json
{
  "RoleArn": "arn:aws:iam::123456789012:role/S3AccessRole",
  "RoleSessionName": "MySession",
  "Tags": [
    {
      "Key": "Project",
      "Value": "DataMigration"
    },
    {
      "Key": "Environment",
      "Value": "Production"
    }
  ]
}
```

## 교차 계정 액세스 시나리오

계정 A의 사용자가 계정 B의 S3 버킷에 접근해야 함

### 구성 단계

1. **계정 B에서 역할 생성**

   ```json
   역할 이름: CrossAccountS3AccessRole
   신뢰 정책: 계정 A의 사용자/역할 신뢰
   권한 정책: S3 읽기/쓰기 권한
   ```

2. **계정 A의 사용자가 역할 가정**

   ```python
   import boto3

   sts_client = boto3.client('sts')

   response = sts_client.assume_role(
       RoleArn='arn:aws:iam::222222222222:role/CrossAccountS3AccessRole',
       RoleSessionName='CrossAccountSession',
       ExternalId='unique-external-id-12345'
   )

   credentials = response['Credentials']
   ```

3. **임시 자격 증명으로 S3 접근**

   ```python
   s3_client = boto3.client(
       's3',
       aws_access_key_id=credentials['AccessKeyId'],
       aws_secret_access_key=credentials['SecretAccessKey'],
       aws_session_token=credentials['SessionToken']
   )

   # 계정 B의 S3 버킷 접근
   s3_client.list_buckets()
   ```

### 보안 고려사항

교차 계정 액세스를 구현할 때는 보안을 위해 몇 가지 고려사항을 준수해야 합니다. 교차 계정 액세스 시에는 반드시 외부 ID를 사용해야 하며, 최소 권한 원칙에 따라 필요한 권한만 부여해야 합니다. 세션 시간 제한을 위해 가능한 짧은 세션 시간을 설정하고, 정기적인 감사를 위해 CloudTrail로 역할 가정 활동을 모니터링해야 합니다.

### 만료 시간

임시 자격 증명의 만료 시간은 기본적으로 1시간이며, 최대 12시간까지 역할 설정에서 변경할 수 있습니다. GetSessionToken과 GetFederationToken의 경우 최대 36시간까지 유효합니다.

### 자동 갱신

일부 AWS SDK는 자동으로 자격 증명을 갱신합니다. EC2 인스턴스 역할의 경우 IMDS가 자동으로 갱신하며, Lambda 실행 역할의 경우 Lambda 서비스가 자동으로 갱신합니다. 하지만 일반 애플리케이션의 경우 수동으로 AssumeRole을 다시 호출해야 합니다.

## 실제 사용 사례

### 시나리오 1: EC2에서 S3 접근

```
1. S3 읽기/쓰기 권한을 가진 IAM 역할 생성
2. EC2 인스턴스에 역할 연결
3. 인스턴스에서 실행되는 애플리케이션이 자동으로 S3 접근
4. 액세스 키 저장 불필요
```

### 시나리오 2: 교차 계정 백업

```
계정 A: 프로덕션 계정
계정 B: 백업 계정

1. 계정 B에 백업 역할 생성 (S3 쓰기 권한)
2. 계정 A의 Lambda 함수가 역할 가정
3. 프로덕션 데이터를 계정 B의 S3 버킷에 백업
```

### 시나리오 3: 페더레이션된 사용자 접근

```
1. 사용자가 회사 Active Directory로 로그인
2. 애플리케이션이 SAML 어설션 획득
3. AssumeRoleWithSAML 호출
4. 임시 자격 증명으로 AWS 리소스 접근
```
