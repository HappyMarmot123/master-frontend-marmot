# Control Tower & SCP

## 개요
AWS Control Tower는 다중 계정 AWS 환경을 설정하고 거버넌스를 제공하는 서비스입니다. 서비스 제어 정책(SCP)을 통해 조직 전체의 권한을 중앙에서 관리할 수 있습니다.

## 핵심 개념

### AWS Control Tower란?
**정의**: 다중 계정 AWS 환경을 설정하고 지속적으로 거버넌스를 제공하는 서비스

**주요 기능**:
- 다중 계정 환경 자동 설정
- 중앙 집중식 거버넌스
- 규정 준수 모니터링
- 계정 팩토리 (Account Factory)를 통한 계정 자동 생성

**왜 필요한가?**:
- 여러 AWS 계정을 효율적으로 관리
- 조직 전체의 보안 및 규정 준수 보장
- 계정 생성 및 관리 자동화
- 중앙 집중식 정책 적용

### 서비스 제어 정책 (SCP)이란?
**정의**: 조직의 계정에 적용할 수 있는 권한 경계를 정의하는 정책

**특징**:
- IAM 정책과 유사하지만 다른 목적
- **IAM 정책**: 사용자/역할에게 권한 부여
- **SCP**: 계정 전체에 대한 권한 경계 설정 (최대 권한 제한)

**작동 원리**:
```
SCP는 IAM 정책보다 우선순위가 높음
→ SCP에서 거부하면 IAM 정책에서 허용해도 거부됨
→ SCP는 "최대 권한"을 정의 (무엇을 할 수 없는지)
```

## AWS Organizations와의 관계

### AWS Organizations
**정의**: 여러 AWS 계정을 중앙에서 관리하는 서비스

**주요 기능**:
- 계정 그룹화 (조직 단위, OU)
- 통합 결제
- 서비스 제어 정책 (SCP)
- 계정 간 리소스 공유

**Control Tower와의 관계**:
- Control Tower는 Organizations를 기반으로 작동
- Control Tower가 Organizations를 자동으로 설정
- Control Tower는 Organizations 위에 추가 기능 제공

## 서비스 제어 정책 (SCP) 상세

### SCP의 목적
**권한 경계 설정**: 계정 내 모든 사용자와 역할이 가질 수 있는 최대 권한을 제한

**예시**:
```
SCP: "특정 리전에서만 리소스 생성 허용"
→ 계정 내 모든 사용자가 다른 리전에 리소스를 만들 수 없음
→ IAM 정책에서 다른 리전 권한을 부여해도 SCP가 차단
```

### SCP 구조
SCP는 IAM 정책과 동일한 JSON 형식을 사용합니다:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Action": [
        "ec2:RunInstances"
      ],
      "Resource": "*",
      "Condition": {
        "StringNotEquals": {
          "ec2:Region": "ap-northeast-2"
        }
      }
    }
  ]
}
```

### SCP 적용 레벨
SCP는 다음 레벨에 적용할 수 있습니다:

1. **루트 레벨**: 조직의 모든 계정에 적용
2. **조직 단위(OU) 레벨**: 특정 OU의 모든 계정에 적용
3. **계정 레벨**: 특정 계정에만 적용

**우선순위**:
- 계정 레벨 SCP가 가장 높은 우선순위
- OU 레벨 SCP
- 루트 레벨 SCP

### SCP 평가 로직
SCP는 IAM 정책과 유사하게 평가됩니다:

1. **명시적 Deny**: 최우선, 즉시 거부
2. **Allow**: 명시적 Allow는 없음 (SCP는 Deny만 사용)
3. **기본**: SCP가 없으면 모든 작업 허용

**중요**: SCP는 권한을 부여하지 않고, 권한을 제한합니다.

### SCP vs IAM 정책

| 항목 | IAM 정책 | SCP |
|------|----------|-----|
| **목적** | 권한 부여 | 권한 제한 (경계 설정) |
| **적용 범위** | 사용자/역할 | 계정 전체 |
| **우선순위** | 낮음 | 높음 (IAM 정책보다 우선) |
| **Effect** | Allow, Deny | 주로 Deny |
| **사용 사례** | 개별 권한 관리 | 조직 전체 정책 |

## Control Tower 구성 요소

### 1. 랜딩 존 (Landing Zone)
**정의**: 다중 계정 환경의 기반 인프라

**구성 요소**:
- **관리 계정 (Management Account)**: Control Tower 설정 및 관리
- **로그 아카이브 계정**: 모든 계정의 로그 중앙 저장
- **감사 계정**: 규정 준수 및 감사 목적

**자동 설정**:
- CloudTrail 로깅
- AWS Config 규칙
- GuardDuty 위협 탐지
- 중앙 집중식 로깅

### 2. 계정 팩토리 (Account Factory)
**정의**: 새로운 AWS 계정을 자동으로 생성하고 구성하는 기능

**작동 과정**:
```
1. 사용자가 계정 생성 요청
2. Account Factory가 새 계정 생성
3. 기본 보안 설정 적용
4. 적절한 OU에 배치
5. 필요한 서비스 활성화
```

**장점**:
- 일관된 계정 구성
- 자동화된 보안 설정
- 규정 준수 보장

### 3. Guardrails (가드레일)
**정의**: 조직 전체에 적용되는 거버넌스 규칙

**유형**:

1. **필수 가드레일 (Mandatory Guardrails)**
   - 모든 계정에 자동 적용
   - 비활성화 불가
   - 예: 루트 사용자 MFA 활성화

2. **강력 권장 가드레일 (Strongly Recommended Guardrails)**
   - 기본적으로 활성화
   - 필요 시 비활성화 가능
   - 예: 암호화된 S3 버킷만 허용

3. **선택적 가드레일 (Elective Guardrails)**
   - 수동으로 활성화
   - 특정 요구사항에 맞춤
   - 예: 특정 리전만 사용

**가드레일 구현 방식**:
- **SCP**: 권한 제한
- **AWS Config 규칙**: 리소스 구성 검사
- **서비스 제어 정책**: 서비스 사용 제한

## 실제 사용 예시

### 시나리오 1: 특정 리전만 사용 허용
**요구사항**: 조직의 모든 계정이 서울 리전(ap-northeast-2)에서만 리소스를 생성할 수 있도록 제한

**SCP 구성**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyAllOutsideSeoul",
      "Effect": "Deny",
      "NotAction": [
        "cloudfront:*",
        "iam:*",
        "route53:*",
        "support:*"
      ],
      "Resource": "*",
      "Condition": {
        "StringNotEquals": {
          "aws:RequestedRegion": "ap-northeast-2"
        }
      }
    }
  ]
}
```

**적용**:
- 루트 레벨에 SCP 연결
- 모든 멤버 계정에 자동 적용
- 서울 리전 외에서 리소스 생성 시도 시 거부

### 시나리오 2: 루트 사용자 작업 제한
**요구사항**: 루트 사용자가 액세스 키를 생성하지 못하도록 제한

**SCP 구성**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyRootUserAccessKeyCreation",
      "Effect": "Deny",
      "Action": [
        "iam:CreateAccessKey"
      ],
      "Resource": "*",
      "Condition": {
        "StringLike": {
          "aws:PrincipalArn": "arn:aws:iam::*:root"
        }
      }
    }
  ]
}
```

### 시나리오 3: 특정 서비스 사용 제한
**요구사항**: 개발 계정에서만 특정 서비스 사용 허용

**SCP 구성**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyEC2OutsideDevAccounts",
      "Effect": "Deny",
      "Action": [
        "ec2:*"
      ],
      "Resource": "*",
      "Condition": {
        "StringNotEquals": {
          "aws:RequestTag/Environment": "dev"
        }
      }
    }
  ]
}
```

## Control Tower 설정 과정

### 1. 초기 설정
```
1. AWS Organizations 활성화
2. Control Tower 활성화
3. 랜딩 존 설정
   - 관리 계정 지정
   - 로그 아카이브 계정 생성
   - 감사 계정 생성
4. 기본 가드레일 활성화
```

### 2. 조직 단위(OU) 구성
```
조직 구조 예시:
Root
├── Security OU
│   ├── 로그 아카이브 계정
│   └── 감사 계정
├── Production OU
│   ├── 프로덕션 계정 1
│   └── 프로덕션 계정 2
└── Development OU
    ├── 개발 계정 1
    └── 개발 계정 2
```

### 3. 가드레일 적용
```
- 루트 레벨: 모든 계정에 적용되는 기본 가드레일
- Production OU: 프로덕션 환경 가드레일
- Development OU: 개발 환경 가드레일
```

## SCP 작성 모범 사례

### 1. 최소 권한 원칙
- 필요한 제한만 적용
- 과도한 제한은 운영 방해

### 2. 점진적 적용
- 처음에는 제한적으로 적용
- 필요에 따라 점진적으로 확장

### 3. 테스트
- 테스트 계정에서 먼저 검증
- 프로덕션 적용 전 충분한 테스트

### 4. 문서화
- 각 SCP의 목적과 영향 명확히 문서화
- 예외 사항 기록

### 5. 정기 검토
- 정기적으로 SCP 검토
- 불필요한 제한 제거

## 주의사항

### SCP 제한사항
1. **관리 계정에는 적용 안 됨**: 관리 계정은 SCP의 영향을 받지 않음
2. **서비스 연결 역할**: 일부 AWS 서비스는 SCP를 우회할 수 있음
3. **루트 사용자**: SCP는 루트 사용자에게도 적용되지만, 일부 작업은 여전히 가능

### 일반적인 실수
1. **과도한 제한**: 필요한 작업까지 차단
2. **테스트 부족**: 프로덕션에 직접 적용
3. **문서화 부족**: SCP 목적과 영향 미기록

## 관련 서비스

### AWS Organizations
- 다중 계정 관리
- SCP 적용
- 통합 결제

### AWS Config
- 리소스 구성 추적
- 규정 준수 검사
- 가드레일 구현

### CloudTrail
- API 호출 로깅
- SCP 거부 이벤트 추적

### IAM Identity Center
- 중앙 집중식 액세스 관리
- Control Tower와 통합

## 실제 사용 사례

### 엔터프라이즈 환경
```
대기업이 50개의 AWS 계정을 관리
- Control Tower로 중앙 집중식 관리
- SCP로 조직 전체 정책 적용
- Account Factory로 새 계정 자동 생성
- 가드레일로 규정 준수 보장
```

### 다중 환경 관리
```
개발, 스테이징, 프로덕션 환경 분리
- 각 환경별 OU 생성
- 환경별 가드레일 적용
- 개발 환경: 유연한 정책
- 프로덕션 환경: 엄격한 정책
```

## 참고 자료
- [Control Tower 공식 문서](https://docs.aws.amazon.com/controltower/)
- [SCP 가이드](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps.html)
- [Organizations 공식 문서](https://docs.aws.amazon.com/organizations/)

