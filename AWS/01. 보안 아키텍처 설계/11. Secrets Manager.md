# Secrets Manager

## 개요
AWS Secrets Manager는 데이터베이스 자격 증명, API 키, OAuth 토큰 등 시크릿을 안전하게 저장하고 관리하는 서비스입니다. 자동 로테이션 기능을 제공합니다.

## 핵심 개념

### Secrets Manager란?
**정의**: 시크릿을 안전하게 저장하고 관리하는 서비스

**주요 기능**:
- 시크릿 저장 및 암호화
- 자동 로테이션
- 액세스 제어
- 감사 및 모니터링

**작동 원리**:
```
애플리케이션
  ↓ (API 호출)
Secrets Manager
  ↓ (KMS로 암호화)
시크릿 반환
```

### 시크릿이란?
**정의**: 민감한 정보 (비밀번호, API 키, 토큰 등)

**예시**:
- 데이터베이스 자격 증명
- API 키
- OAuth 토큰
- 암호화 키

## Secrets Manager 주요 기능

### 1. 시크릿 저장
**정의**: 시크릿을 암호화하여 저장

**저장 형식**:
- JSON 형식
- 키-값 쌍
- 구조화된 데이터

**예시**:
```json
{
  "username": "admin",
  "password": "secret123",
  "host": "database.example.com",
  "port": 3306
}
```

### 2. 자동 로테이션
**정의**: 시크릿을 주기적으로 자동 교체

**로테이션 주기**:
- 일, 주, 월 단위 설정 가능
- Lambda 함수로 구현

**작동 원리**:
```
1. 로테이션 일정 도래
2. Lambda 함수 실행
3. 새 자격 증명 생성
4. 서비스에 새 자격 증명 적용
5. 시크릿 업데이트
6. 이전 자격 증명 비활성화
```

**지원 서비스**:
- RDS (MySQL, PostgreSQL, MariaDB, Oracle, SQL Server)
- DocumentDB
- Redshift
- 기타 (Lambda 함수로 커스텀 구현)

### 3. 버전 관리
**정의**: 시크릿의 여러 버전 유지

**특징**:
- 이전 버전 보관
- 특정 버전으로 액세스 가능
- 롤백 가능

**버전 레이블**:
- AWSCURRENT: 현재 버전
- AWSPREVIOUS: 이전 버전
- 커스텀 레이블

### 4. 액세스 제어
**정의**: IAM 정책으로 시크릿 액세스 제어

**권한**:
- GetSecretValue: 시크릿 값 읽기
- PutSecretValue: 시크릿 값 업데이트
- DescribeSecret: 시크릿 메타데이터 조회
- RotateSecret: 시크릿 로테이션

## Secrets Manager vs Systems Manager Parameter Store

### 비교표

| 항목 | Secrets Manager | Parameter Store |
|------|----------------|-----------------|
| **자동 로테이션** | 지원 | 미지원 |
| **비용** | 시크릿당 월 $0.40 | 무료 (Standard), 유료 (Advanced) |
| **크기 제한** | 64KB | 4KB (Standard), 8KB (Advanced) |
| **버전 관리** | 지원 | 지원 |
| **암호화** | KMS 필수 | 선택적 |
| **사용 사례** | 자격 증명, API 키 | 설정 값, 일반 파라미터 |

### 선택 기준

#### Secrets Manager를 선택하는 경우
- 자동 로테이션이 필요한 자격 증명
- 데이터베이스 자격 증명
- API 키
- 높은 보안 필요

#### Parameter Store를 선택하는 경우
- 일반 설정 값
- 자동 로테이션 불필요
- 비용 최적화
- 작은 값 (4KB 이하)

## 사용 사례

### 시나리오 1: 데이터베이스 자격 증명 관리
```
애플리케이션
  ↓ (GetSecretValue API)
Secrets Manager
  ↓ (RDS 자격 증명)
RDS 데이터베이스
```

**자동 로테이션**:
```
1. Lambda 함수가 주기적으로 실행
2. RDS에서 새 비밀번호 생성
3. RDS 비밀번호 변경
4. Secrets Manager 업데이트
5. 애플리케이션은 자동으로 새 자격 증명 사용
```

### 시나리오 2: API 키 관리
```
애플리케이션
  ↓
Secrets Manager (외부 API 키)
  ↓
외부 API 호출
```

### 시나리오 3: 마이크로서비스 간 인증
```
서비스 A
  ↓
Secrets Manager (공유 토큰)
  ↓
서비스 B 인증
```

## 자동 로테이션 설정

### RDS 자동 로테이션
**구성**:
```
1. Secrets Manager에서 RDS 자격 증명 저장
2. 자동 로테이션 활성화
3. Lambda 함수 선택 (AWS 제공 또는 커스텀)
4. 로테이션 일정 설정 (예: 30일마다)
```

**작동 과정**:
```
로테이션 트리거
  ↓
Lambda 함수 실행
  ├── 1단계: 새 비밀번호 생성
  ├── 2단계: RDS 비밀번호 변경
  ├── 3단계: Secrets Manager 업데이트
  └── 4단계: 이전 비밀번호 비활성화
```

**Lambda 함수 단계**:
- **createSecret**: 새 자격 증명 생성
- **setSecret**: 서비스에 새 자격 증명 설정
- **testSecret**: 새 자격 증명 테스트
- **finishSecret**: 로테이션 완료

## 모범 사례

### 1. 최소 권한 원칙
- 필요한 애플리케이션만 액세스 허용
- IAM 정책으로 제어
- 정기적인 권한 검토

### 2. 자동 로테이션
- 가능한 한 자동 로테이션 활성화
- 정기적인 자격 증명 교체
- 보안 강화

### 3. 모니터링
- CloudTrail로 액세스 로깅
- CloudWatch로 로테이션 모니터링
- 비정상 액세스 감지

### 4. 버전 관리
- 이전 버전 보관
- 롤백 가능
- 감사 추적

## 비용

### Secrets Manager 비용
- **시크릿 저장**: 시크릿당 월 $0.40
- **API 호출**: 10,000개당 $0.05

### 비용 최적화
- 불필요한 시크릿 제거
- Parameter Store 고려 (로테이션 불필요한 경우)
- 적절한 액세스 패턴

## 관련 서비스

### KMS
- 시크릿 암호화
- 키 관리

### Lambda
- 자동 로테이션
- 커스텀 로테이션 로직

### RDS
- 자동 로테이션 지원
- 자격 증명 관리

### CloudTrail
- 액세스 로깅
- 감사 추적

## 참고 자료
- [Secrets Manager 공식 문서](https://docs.aws.amazon.com/secretsmanager/)
- [자동 로테이션 가이드](https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets.html)

