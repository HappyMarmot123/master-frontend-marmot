# IAM (Identity and Access Management)

## 개요

IAM은 AWS 리소스에 대한 액세스를 안전하게 제어하는 웹 서비스입니다. 누가(who), 무엇을(what), 어떻게(how) 액세스할 수 있는지를 정의하고 관리합니다. 전통적인 온프레미스 환경에서는 각 서버에 개별적으로 사용자 계정을 만들고 권한을 관리해야 했습니다. AWS에서는 수백, 수천 개의 리소스가 있을 수 있기 때문에, 중앙 집중식으로 액세스를 관리하는 시스템이 필요합니다.

### IAM 구성 요소

#### 1. 사용자 (User)

사용자는 AWS 서비스 및 리소스에 액세스하는 사람 또는 애플리케이션을 나타내는 엔티티입니다.

**유형**:

**루트 사용자 (Root User)**

루트 사용자는 AWS 계정을 생성할 때 자동으로 생성되는 최상위 계정입니다. 모든 리소스에 대한 완전한 액세스 권한을 가지고 있습니다. 하지만 루트 사용자는 계정 관리 작업, 결제 정보 변경 작업만 수행해야 합니다. EC2 인스턴스를 만들거나 S3 버킷에 파일을 저장하는 것 같은 작업은 루트 사용자로 하면 안 됩니다. 루트 사용자는 보안상 매우 중요하기 때문에 반드시 MFA(Multi-Factor Authentication, 2단계 인증)를 활성화해야 합니다. 만약 루트 사용자 계정이 해킹당하면, 해커가 계정의 모든 것을 제어할 수 있기 때문입니다.

**IAM 사용자 (IAM User)**

IAM 사용자는 루트 사용자나 관리 권한이 있는 IAM 사용자가 생성하는 일반 사용자 계정입니다. IAM 사용자는 필요한 권한만 부여받아야 합니다. 예를 들어, 개발자에게는 개발 환경 리소스에만 접근할 수 있는 권한을 주고, 운영자에게는 프로덕션 환경을 관리할 수 있는 권한을 줍니다. 이렇게 최소 권한 원칙을 적용하면 보안 위험을 줄일 수 있습니다. IAM 사용자는 콘솔에 접근할 때는 사용자 이름과 비밀번호를 사용하고, 프로그래밍 방식으로 접근할 때는 액세스 키 ID와 시크릿 액세스 키를 사용합니다. 하나의 AWS 계정에는 무제한으로 IAM 사용자를 만들 수 있어서, 회사의 모든 직원이나 애플리케이션마다 별도의 사용자를 만들 수 있습니다.

실제로 회사에서 AWS를 사용할 때는 각 직원의 역할에 맞게 IAM 사용자를 만들고 권한을 부여합니다. 예를 들어, 개발자 A에게는 S3 버킷에서 파일을 읽고 쓸 수 있는 권한만 주고, 개발자 B에게는 EC2 인스턴스를 시작하거나 중지할 수 있는 권한만 줍니다. 관리자에게는 모든 권한을 줄 수 있지만, 루트 사용자는 아닙니다. 이렇게 각 사용자에게 필요한 최소한의 권한만 부여하는 것이 보안상 안전합니다.

#### 2. 그룹 (Group)

그룹은 여러 IAM 사용자들을 하나로 묶어서 관리하는 컬렉션입니다.

그룹의 가장 큰 장점은 권한을 일괄 관리할 수 있다는 것입니다. 개발자 그룹에 S3 읽기/쓰기 권한과 EC2 시작/중지 권한을 부여하면, 그룹에 속한 모든 사용자에게 자동으로 같은 권한이 부여됩니다. 이렇게 하면 각 사용자에게 개별적으로 권한을 부여할 필요가 없어서 관리가 훨씬 쉬워집니다.

사용자는 여러 그룹에 속할 수 있고, 여러 그룹의 권한이 합쳐집니다. 예를 들어, 사용자가 개발자 그룹과 테스터 그룹에 모두 속해 있다면, 두 그룹의 권한을 모두 가지게 됩니다. 하지만 그룹은 다른 그룹을 포함할 수 없습니다. 정책은 그룹에 연결되지만, 그룹이 직접 리소스에 액세스할 수는 없습니다. 그룹은 단지 사용자들을 묶어서 관리하는 도구일 뿐입니다.

실제로는 개발자 그룹을 만들어서 개발 환경 리소스에만 접근할 수 있는 권한을 부여하거나, 운영자 그룹을 만들어서 프로덕션 환경을 관리할 수 있는 권한을 부여합니다. 또는 읽기 전용 그룹을 만들어서 모니터링이나 감사 목적으로 리소스를 조회만 할 수 있도록 할 수 있습니다.

#### 3. 역할 (Role)

역할은 임시 자격 증명을 가진 엔티티로, 사용자나 서비스, 애플리케이션이 필요할 때 "가정(assume)"할 수 있는 권한 집합입니다.

역할과 사용자의 가장 큰 차이점은 자격 증명의 성격입니다. 사용자는 영구 자격 증명을 가지고 있습니다. 비밀번호나 액세스 키를 가지고 있어서 언제든지 사용할 수 있습니다. 하지만 역할은 임시 자격 증명을 사용합니다. 역할을 "가정"할 때만 자격 증명을 받고, 그 자격 증명은 시간이 지나면 만료됩니다.

역할을 가정하는 과정은 다음과 같습니다. 먼저 엔티티가 역할을 가정하고 싶다고 요청합니다. 그러면 IAM이 그 요청을 검증해서 권한이 있는지 확인합니다. 검증이 통과되면 STS(Security Token Service)가 임시 자격 증명을 발급합니다. 이 임시 자격 증명에는 액세스 키 ID, 시크릿 액세스 키, 세션 토큰이 포함됩니다. 이 임시 자격 증명을 사용해서 AWS 서비스에 접근할 수 있습니다. 자격 증명은 기본적으로 1시간 후에 만료되고, 최대 12시간까지 연장할 수 있습니다.

역할은 여러 상황에서 사용됩니다. 예를 들어, EC2 인스턴스가 S3에 접근해야 할 때가 있습니다. 이때 옵션은 두 가지입니다. 하나는 액세스 키를 인스턴스에 저장하는 것인데, 이는 보안상 위험합니다. 액세스 키가 유출되면 해커가 그 키를 사용해서 S3에 접근할 수 있기 때문입니다. 더 나은 방법은 IAM 역할을 인스턴스에 연결하는 것입니다. 그러면 인스턴스가 자동으로 역할을 가정하고, 임시 자격 증명을 받아서 S3에 접근할 수 있습니다.

Lambda 함수가 DynamoDB에 접근해야 할 때도 역할을 사용합니다. Lambda 실행 역할을 만들고, 그 역할에 DynamoDB 읽기/쓰기 권한을 부여한 다음, Lambda 함수에 그 역할을 연결합니다. 그러면 함수가 실행될 때 자동으로 역할을 가정해서 DynamoDB에 접근할 수 있습니다.

교차 계정 액세스에도 역할을 사용합니다. 예를 들어, 계정 A의 사용자가 계정 B의 리소스에 접근해야 할 때, 계정 B에 역할을 만들고 그 역할의 신뢰 정책에 계정 A의 사용자를 추가합니다. 그러면 계정 A의 사용자가 그 역할을 가정해서 임시 자격 증명을 받고, 그 자격 증명으로 계정 B의 리소스에 접근할 수 있습니다.

#### 4. 정책 (Policy)

정책은 권한을 정의하는 JSON 형식의 문서입니다.

**정책 구조**:

```json
{
  "Version": "2012-10-17", // 정책 언어 버전
  "Statement": [
    // 권한 문장 배열
    {
      "Effect": "Allow", // Allow 또는 Deny
      "Action": [
        // 허용/거부할 작업
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::example-bucket/*", // 적용 대상 리소스
      "Condition": {
        // 선택적 조건
        "IpAddress": {
          "aws:SourceIp": "203.0.113.0/24"
        }
      }
    }
  ]
}
```

정책의 각 요소는 다음과 같은 의미를 가집니다.

- Version: 정책 언어 버전을 나타내며, 항상 "2012-10-17"을 사용합니다.
- Effect: 권한을 허용할지 거부할지를 결정합니다. Allow는 권한을 허용하는 것이고, Deny는 권한을 명시적으로 거부하는 것입니다. Deny는 Allow보다 우선순위가 높아서, Deny가 있으면 다른 정책에서 Allow가 있어도 거부됩니다.
- Action: 수행할 수 있는 작업을 정의합니다. 형식은 "서비스:작업"으로, 예를 들어 "s3:GetObject"는 S3에서 객체를 가져오는 작업이고, "ec2:StartInstances"는 EC2 인스턴스를 시작하는 작업입니다. 와일드카드를 사용할 수도 있어서, "s3:\*"는 모든 S3 작업을 의미합니다.
- Resource: 이 정책이 적용될 리소스를 지정합니다. ARN(Amazon Resource Name) 형식을 사용하고, 와일드카드 "\*"를 사용하면 모든 리소스에 적용됩니다.
- Condition: 선택적 조건으로, IP 주소나 시간, 태그 등을 사용해서 접근을 제한할 수 있습니다.

정책에는 두 가지 유형이 있습니다. 관리형 정책은 AWS에서 제공하거나 사용자가 생성한 재사용 가능한 정책입니다. 여러 사용자, 그룹, 역할에 연결할 수 있고, 버전 관리도 지원됩니다. 관리형 정책의 장점은 재사용성이 높고, 일관성을 유지하기 쉽고, 유지보수가 용이하다는 것입니다. 인라인 정책은 특정 사용자, 그룹, 역할에 직접 연결된 정책입니다. 해당 엔티티에만 적용되고, 재사용할 수 없습니다. 인라인 정책의 장점은 간단한 권한을 빠르게 설정할 수 있고, 엔티티별로 맞춤 설정을 할 수 있다는 것입니다. 하지만 재사용이 불가능하고, 유지보수가 어렵다는 단점이 있습니다.

## 정책 평가 로직

IAM이 권한 요청을 평가할 때는 몇 가지 기본 원칙을 따릅니다. 첫째, 기본적으로 모든 요청은 거부됩니다. 명시적으로 허용하지 않으면 거부하는 것이 기본 원칙입니다. 둘째, 정책에서 Allow가 있으면 그 요청은 허용됩니다. 셋째, 정책에서 Deny가 있으면 항상 거부됩니다. Deny는 Allow보다 우선순위가 높아서, Deny가 있으면 다른 정책에서 Allow가 있어도 거부됩니다.

IAM이 권한 요청을 평가하는 순서는 다음과 같습니다. 먼저 명시적 Deny를 확인합니다. 모든 정책에서 Deny 문장을 찾아보고, 하나라도 Deny가 있으면 즉시 거부합니다. 다른 정책은 더 이상 확인하지 않습니다. Deny가 없으면 다음 단계로 넘어갑니다. 두 번째로 모든 정책에서 Allow를 확인합니다. 사용자나 역할에 연결된 모든 정책, 그룹에 연결된 정책, 리소스 기반 정책까지 모두 확인해서, 하나라도 Allow가 있으면 허용합니다.

## 사용 사례

### 1. 사용자 기반 액세스

개발팀이 AWS 콘솔에 접근해서 리소스를 관리해야 하는 상황을 생각해봅시다. 이 경우 각 개발자에게 IAM 사용자를 만들고, 개발자 그룹을 생성해서 그룹에 개발 환경 접근 권한을 부여합니다. 그리고 각 개발자를 그룹에 추가하고, 보안을 강화하기 위해 MFA를 활성화합니다. 이렇게 하면 개별 사용자를 추적할 수 있고, 사용자별로 다른 권한을 부여할 수 있으며, CloudTrail로 사용자 활동을 로깅할 수 있습니다.

### 2. 역할 기반 액세스 (EC2)

EC2 인스턴스에서 실행되는 애플리케이션이 S3에 접근해야 하는 상황을 생각해봅시다. 이 경우 S3 읽기/쓰기 권한을 가진 IAM 역할을 만들고, 역할의 신뢰 정책을 설정해서 EC2 서비스가 그 역할을 가정할 수 있도록 합니다. 그리고 EC2 인스턴스에 그 역할을 연결합니다. 그러면 애플리케이션이 AWS SDK를 통해 자동으로 임시 자격 증명을 받아서 S3에 접근할 수 있습니다. 이 방법의 장점은 액세스 키를 코드나 환경 변수에 저장할 필요가 없고, 자동으로 자격 증명이 교체되어서 보안이 강화되며, 인스턴스별로 다른 권한을 부여할 수 있다는 것입니다.

### 3. 교차 계정 액세스

계정 A의 사용자가 계정 B의 S3 버킷에 접근해야 하는 상황을 생각해봅시다. 이 경우 계정 B에 역할을 만들고, 그 역할의 신뢰 정책에 계정 A의 사용자 ARN을 추가합니다. 그리고 역할에 S3 접근 권한을 부여합니다. 그러면 계정 A의 사용자가 그 역할을 가정해서 임시 자격 증명을 받고, 그 자격 증명으로 계정 B의 리소스에 접근할 수 있습니다. 이 방법의 장점은 계정 B에 사용자를 만들 필요가 없고, 임시 자격 증명을 사용해서 보안이 강화되며, 필요하면 외부 ID를 통한 추가 보안도 설정할 수 있다는 것입니다.

## 중요 개념

### 1. 최소 권한 원칙 (Principle of Least Privilege)

최소 권한 원칙은 사용자나 역할에게 작업을 수행하는 데 필요한 최소한의 권한만 부여하는 보안 원칙입니다. 이 원칙이 중요한 이유는 여러 가지가 있습니다. 권한이 과도하면 실수로 중요한 리소스를 삭제하거나 수정할 수 있습니다. 예를 들어, 개발자에게 모든 권한을 주면 실수로 프로덕션 데이터베이스를 삭제할 수도 있습니다. 또한 보안 침해가 발생했을 때 피해 범위를 최소화할 수 있습니다. 해커가 한 사용자의 계정을 탈취해도, 그 사용자가 가진 권한이 제한적이면 피해가 크지 않습니다. 그리고 많은 규정 준수 요구사항을 충족하는 데도 도움이 됩니다.

최소 권한 원칙을 실행하는 방법은 다음과 같습니다. 처음에는 최소 권한으로 시작합니다. 사용자나 역할을 만들 때 필요한 최소한의 권한만 부여합니다. 그리고 필요에 따라 점진적으로 권한을 추가합니다. 사용자가 특정 작업을 수행할 수 없다고 하면, 그때 필요한 권한만 추가합니다. 정기적으로 권한을 검토하고 정리합니다. 사용하지 않는 권한은 제거합니다. 예를 들어, 개발자에게는 개발 환경 리소스만 접근할 수 있는 권한을 부여하면, 프로덕션 리소스에 접근할 수 없어서 안전합니다.

### 2. MFA (Multi-Factor Authentication)

MFA는 두 가지 이상의 인증 요소를 요구하는 보안 메커니즘입니다. 인증 요소는 세 가지가 있습니다. 비밀번호, 하드웨어 토큰이나 스마트폰 앱, 생체 인증입니다. 지문이나 얼굴 인식이 여기에 해당합니다.

MFA 유형에는 여러 가지가 있습니다. 하드웨어 MFA 디바이스는 물리적 토큰입니다. 가상 MFA 디바이스는 스마트폰 앱으로, Google Authenticator나 Authy 같은 앱을 사용합니다. SMS MFA는 문자 메시지로 코드를 전송하는 방식인데, 보안 수준이 낮아서 권장하지 않습니다.

MFA가 작동하는 원리는 다음과 같습니다. 사용자가 AWS 콘솔에 로그인을 시도하면, 먼저 사용자 이름과 비밀번호를 입력합니다. 그 다음 MFA 코드를 요청하면, MFA 디바이스에서 코드가 생성됩니다. 사용자가 그 코드를 입력하면 인증이 성공해서 접근이 허용됩니다.

### 3. 역할 vs 사용자 선택 기준

역할과 사용자 중 어떤 것을 사용해야 할지 결정할 때는 상황에 따라 다릅니다.
역할을 사용해야 하는 경우는 다음과 같습니다.

- AWS 서비스가 다른 AWS 서비스에 접근할 때, 예를 들어 EC2가 S3에 접근하거나 Lambda가 DynamoDB에 접근할 때는 역할을 사용합니다.
- 교차 계정 액세스가 필요할 때
- 임시 액세스가 필요한 경우
- 액세스 키를 코드나 환경 변수에 저장하고 싶지 않을 때

사용자를 사용해야 하는 경우는 다음과 같습니다.

- 사람이 AWS 콘솔에 접근할 때
- 장기적인 프로그래밍 방식 접근이 필요할 때
- 개별 사용자를 추적해야 하는 경우
