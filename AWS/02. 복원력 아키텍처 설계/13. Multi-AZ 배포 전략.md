# Multi-AZ 배포 전략

## 개요
Multi-AZ (Multi-Availability Zone) 배포는 여러 가용 영역에 리소스를 분산 배치하여 고가용성과 내결함성을 확보하는 전략입니다.

## 핵심 개념

### 가용 영역 (AZ)이란?
**정의**: 리전 내에 위치한 독립적인 데이터 센터

**특징**:
- 각 AZ는 독립적인 전원, 네트워크, 냉각 시스템
- AZ 간 낮은 지연 시간 (1-2ms)
- 단일 AZ 장애 시 다른 AZ가 자동으로 처리

### Multi-AZ 배포란?
**정의**: 최소 2개 이상의 가용 영역에 리소스를 배포

**목적**:
- **고가용성**: 단일 AZ 장애 시에도 서비스 지속
- **내결함성**: 장애 발생 시 자동 복구
- **성능**: 지리적 분산으로 지연 시간 감소

**작동 원리**:
```
리전 (서울)
  ├── 가용 영역 A
  │   └── 리소스 배포
  └── 가용 영역 B
      └── 리소스 배포

AZ A 장애 시 → AZ B가 자동으로 처리
```

## Multi-AZ 배포 패턴

### 1. Active-Passive (액티브-패시브)
**정의**: 하나의 AZ가 활성, 다른 AZ가 대기

**구조**:
```
Primary (AZ A) - 활성
  ↓ (복제)
Standby (AZ B) - 대기
```

**장애 조치**:
```
AZ A 장애
  ↓
자동으로 AZ B 활성화
  ↓
서비스 복구
```

**사용 사례**:
- RDS Multi-AZ
- ElastiCache Redis (복제 그룹)

### 2. Active-Active (액티브-액티브)
**정의**: 여러 AZ가 동시에 활성 상태

**구조**:
```
AZ A - 활성 (50% 트래픽)
AZ B - 활성 (50% 트래픽)
```

**장애 조치**:
```
AZ A 장애
  ↓
AZ B가 100% 트래픽 처리
  ↓
서비스 지속
```

**사용 사례**:
- ALB (여러 AZ에 자동 배포)
- Auto Scaling Group
- ECS 서비스

## 서비스별 Multi-AZ 구현

### 1. RDS Multi-AZ

#### RDS Multi-AZ 구성
```
Primary (AZ A)
  ↓ (동기 복제)
Standby (AZ B)
```

**특징**:
- **동기 복제**: 데이터 일관성 보장
- **자동 장애 조치**: 60-120초 내
- **DNS 자동 변경**: 애플리케이션 변경 불필요

**장애 조치 과정**:
```
1. Primary 장애 감지
2. Standby를 Primary로 승격
3. DNS 레코드 자동 변경
4. 애플리케이션 자동 연결
5. 서비스 복구 (60-120초)
```

**비용**: 단일 AZ 대비 약 2배

#### RDS Multi-AZ vs Read Replica

| 항목 | Multi-AZ | Read Replica |
|------|----------|--------------|
| **목적** | 고가용성 | 읽기 성능, 재해 복구 |
| **복제** | 동기 | 비동기 |
| **장애 조치** | 자동 (60-120초) | 수동 승격 |
| **읽기** | Primary만 | 복제본에서 가능 |
| **비용** | 약 2배 | 인스턴스 비용 |

### 2. ElastiCache Multi-AZ

#### Redis 복제 그룹
```
Primary (AZ A)
  ↓ (비동기 복제)
Replica 1 (AZ B)
Replica 2 (AZ C)
```

**특징**:
- 자동 장애 조치
- 읽기 전용 복제본
- 여러 AZ에 분산

#### Memcached 클러스터
```
노드 1 (AZ A)
노드 2 (AZ B)
노드 3 (AZ C)
```

**특징**:
- 샤딩 (데이터 분산)
- 노드 장애 시 데이터 손실 가능
- 고가용성보다 성능 우선

### 3. ALB Multi-AZ

#### ALB 자동 배포
```
ALB (자동으로 여러 AZ에 배포)
  ├── AZ A
  └── AZ B
```

**특징**:
- **자동 배포**: ALB는 항상 여러 AZ에 배포
- **고가용성**: 단일 AZ 장애 시에도 작동
- **대상 그룹**: 여러 AZ에 분산 권장

**구성**:
```
ALB
  ├── AZ A
  │   └── 대상 그룹 (인스턴스 A1, A2)
  └── AZ B
      └── 대상 그룹 (인스턴스 B1, B2)
```

### 4. Auto Scaling Group Multi-AZ

#### ASG 구성
```
Auto Scaling Group
  ├── 최소 크기: 2
  ├── 최대 크기: 10
  └── 가용 영역: AZ A, AZ B
```

**특징**:
- 여러 AZ에 인스턴스 분산
- 단일 AZ 장애 시 다른 AZ에서 자동 확장
- 고가용성 보장

**구성 예시**:
```
ASG 설정:
- 가용 영역: ap-northeast-2a, ap-northeast-2c
- 최소 크기: 2 (AZ당 1개)
- 원하는 용량: 4 (AZ당 2개)
- 최대 크기: 10

결과:
- AZ A: 2개 인스턴스
- AZ C: 2개 인스턴스
```

### 5. ECS Multi-AZ

#### ECS 서비스 배포
```
ECS 서비스
  ├── 작업 1 (AZ A)
  ├── 작업 2 (AZ B)
  └── 작업 3 (AZ C)
```

**특징**:
- 작업을 여러 AZ에 분산
- 서비스가 자동으로 분산 배포
- 단일 AZ 장애 시 다른 AZ에서 작업 실행

**구성**:
```
ECS 서비스 설정:
- 원하는 개수: 6
- 배치 전략: 분산 (AZ별 균등 분산)

결과:
- AZ A: 2개 작업
- AZ B: 2개 작업
- AZ C: 2개 작업
```

## Multi-AZ 아키텍처 패턴

### 패턴 1: 3-Tier 아키텍처
```
인터넷
  ↓
ALB (Multi-AZ)
  ├── AZ A
  └── AZ B
  ↓
웹 서버 (Auto Scaling Group, Multi-AZ)
  ├── AZ A: 2개 인스턴스
  └── AZ B: 2개 인스턴스
  ↓
애플리케이션 서버 (Auto Scaling Group, Multi-AZ)
  ├── AZ A: 2개 인스턴스
  └── AZ B: 2개 인스턴스
  ↓
데이터베이스 (RDS Multi-AZ)
  ├── Primary (AZ A)
  └── Standby (AZ B)
```

### 패턴 2: 마이크로서비스
```
API Gateway
  ↓
ALB (Multi-AZ)
  ↓
ECS 서비스 (Multi-AZ)
  ├── 서비스 A (AZ A, AZ B)
  ├── 서비스 B (AZ A, AZ B)
  └── 서비스 C (AZ A, AZ B)
  ↓
ElastiCache (Redis Multi-AZ)
  ├── Primary (AZ A)
  └── Replica (AZ B)
```

## 장애 조치 전략

### 1. 자동 장애 조치
**서비스**: RDS Multi-AZ, ElastiCache Redis

**특징**:
- 자동 감지 및 복구
- 애플리케이션 변경 불필요
- 빠른 복구 (수십 초 ~ 수분)

### 2. 로드 밸런서 기반 장애 조치
**서비스**: ALB, NLB

**특징**:
- 헬스 체크 기반
- 비정상 대상 자동 제거
- 정상 대상으로만 트래픽 라우팅

### 3. Auto Scaling 기반 장애 조치
**서비스**: Auto Scaling Group

**특징**:
- 비정상 인스턴스 자동 교체
- 여러 AZ에 분산
- 자동 확장

## 모범 사례

### 1. 최소 2개 AZ 사용
- 항상 최소 2개 이상의 AZ에 배포
- 단일 장애 지점 제거

### 2. 균등 분산
- 리소스를 AZ별로 균등하게 분산
- 한 AZ에 과도한 리소스 집중 방지

### 3. 독립성
- 각 AZ의 리소스가 독립적으로 작동
- AZ 간 의존성 최소화

### 4. 모니터링
- AZ별 리소스 모니터링
- 장애 조치 테스트
- 성능 지표 추적

### 5. 비용 고려
- Multi-AZ는 비용 증가
- 중요도에 따라 선택
- 프로덕션은 필수

## 비용 고려사항

### Multi-AZ 비용
- **RDS Multi-AZ**: 단일 AZ 대비 약 2배
- **ElastiCache 복제**: 복제본 인스턴스 비용
- **데이터 전송**: AZ 간 데이터 전송 비용 (무료)

### 비용 최적화
- 중요하지 않은 워크로드는 단일 AZ
- 프로덕션만 Multi-AZ
- 읽기 전용 복제본 활용

## 실제 사용 예시

### 예시 1: 고가용성 웹 애플리케이션
```
ALB (Multi-AZ)
  ↓
Auto Scaling Group (Multi-AZ, 최소 4개)
  ├── AZ A: 2개
  └── AZ B: 2개
  ↓
RDS Multi-AZ
  ├── Primary (AZ A)
  └── Standby (AZ B)
```

### 예시 2: 마이크로서비스
```
API Gateway
  ↓
ALB (Multi-AZ)
  ↓
ECS 서비스 (Multi-AZ, 원하는 개수: 6)
  ├── AZ A: 3개 작업
  └── AZ B: 3개 작업
  ↓
ElastiCache Redis (Multi-AZ)
  ├── Primary (AZ A)
  └── Replica (AZ B)
```

## 관련 서비스

### Route 53
- Health Check 기반 라우팅
- Multi-Region 장애 조치

### CloudWatch
- AZ별 모니터링
- 장애 감지 및 알람

### Auto Scaling
- 여러 AZ에 자동 분산
- 장애 시 자동 확장

## 참고 자료
- [Multi-AZ 배포 가이드](https://docs.aws.amazon.com/wellarchitected/latest/reliability-pillar/design-for-failure.html)
- [RDS Multi-AZ](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.MultiAZ.html)

