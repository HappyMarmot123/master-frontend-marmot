# Step Functions

## 개요
AWS Step Functions는 분산 애플리케이션의 워크플로를 시각적으로 구성하고 자동화하는 서비스입니다. 여러 AWS 서비스를 조합하여 복잡한 비즈니스 로직을 구현할 수 있습니다.

## 핵심 개념

### Step Functions란?
**정의**: 서버리스 워크플로 오케스트레이션 서비스

**주요 기능**:
- 여러 AWS 서비스를 순차적/병렬로 실행
- 조건부 분기 및 에러 처리
- 재시도 및 대기
- 상태 관리

**왜 필요한가?**:
- 복잡한 비즈니스 로직을 시각적으로 표현
- 여러 서비스를 조합하여 워크플로 구성
- 에러 처리 및 재시도 자동화
- 상태 추적 및 모니터링

### 상태 머신 (State Machine)
**정의**: 워크플로를 정의하는 JSON 문서

**구성 요소**:
- **상태 (State)**: 워크플로의 각 단계
- **전이 (Transition)**: 상태 간 이동
- **입력/출력**: 각 상태의 데이터

**예시**:
```json
{
  "Comment": "주문 처리 워크플로",
  "StartAt": "주문 검증",
  "States": {
    "주문 검증": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:...",
      "Next": "재고 확인"
    },
    "재고 확인": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:...",
      "Next": "결제 처리"
    }
  }
}
```

## 상태 유형

### 1. Task (작업)
**정의**: 실제 작업을 수행하는 상태

**리소스 유형**:
- Lambda 함수
- ECS 작업
- Activity (외부 프로세스)
- AWS 서비스 통합

**예시**:
```json
{
  "Type": "Task",
  "Resource": "arn:aws:lambda:region:account:function:ProcessOrder",
  "Next": "SendNotification"
}
```

### 2. Choice (선택)
**정의**: 조건에 따라 다른 경로로 분기

**예시**:
```json
{
  "Type": "Choice",
  "Choices": [
    {
      "Variable": "$.orderAmount",
      "NumericGreaterThan": 10000,
      "Next": "ManagerApproval"
    }
  ],
  "Default": "ProcessOrder"
}
```

### 3. Parallel (병렬)
**정의**: 여러 작업을 동시에 실행

**예시**:
```json
{
  "Type": "Parallel",
  "Branches": [
    {
      "StartAt": "SendEmail",
      "States": {
        "SendEmail": {
          "Type": "Task",
          "Resource": "arn:aws:lambda:...",
          "End": true
        }
      }
    },
    {
      "StartAt": "SendSMS",
      "States": {
        "SendSMS": {
          "Type": "Task",
          "Resource": "arn:aws:lambda:...",
          "End": true
        }
      }
    }
  ],
  "End": true
}
```

### 4. Wait (대기)
**정의**: 지정된 시간 동안 대기

**예시**:
```json
{
  "Type": "Wait",
  "Seconds": 60,
  "Next": "CheckStatus"
}
```

### 5. Succeed (성공)
**정의**: 워크플로 성공 종료

### 6. Fail (실패)
**정의**: 워크플로 실패 종료

### 7. Pass (통과)
**정의**: 입력을 변환하거나 전달만 하는 상태

## 실행 유형

### 1. Standard (표준)
**특징**:
- 최대 1년 실행 가능
- 정확한 실행 순서 보장
- 실행 이력 보관 (90일)

**사용 사례**:
- 긴 실행 시간이 필요한 워크플로
- 실행 이력이 중요한 경우

**비용**:
- 상태 전이: 100만 전이당 $25

### 2. Express (고속)
**특징**:
- 최대 5분 실행
- 높은 처리량
- 실행 이력 제한적 (CloudWatch Logs)

**사용 사례**:
- 높은 처리량이 필요한 경우
- 짧은 실행 시간
- 실시간 데이터 처리

**비용**:
- 실행: 100만 실행당 $1.00
- 상태 전이: 100만 전이당 $0.025

## 워크플로 패턴

### 패턴 1: 순차 실행
```
시작 → 작업 1 → 작업 2 → 작업 3 → 종료
```

**예시**: 주문 처리
```
주문 검증 → 재고 확인 → 결제 처리 → 배송 준비
```

### 패턴 2: 병렬 실행
```
시작
  ├── 작업 A
  ├── 작업 B
  └── 작업 C
종료
```

**예시**: 주문 완료 알림
```
주문 완료
  ├── 이메일 전송
  ├── SMS 전송
  └── 푸시 알림
```

### 패턴 3: 조건부 분기
```
시작 → 조건 확인
  ├── 조건 A → 작업 A
  └── 조건 B → 작업 B
종료
```

**예시**: 주문 금액에 따른 처리
```
주문 금액 확인
  ├── > 10000 → 관리자 승인
  └── <= 10000 → 자동 처리
```

### 패턴 4: 재시도 및 에러 처리
```
작업 실행
  ├── 성공 → 다음 작업
  └── 실패 → 재시도 (최대 3회)
      ├── 성공 → 다음 작업
      └── 실패 → DLQ로 전송
```

## 실제 사용 예시

### 예시 1: 이미지 처리 파이프라인
```json
{
  "StartAt": "이미지 업로드",
  "States": {
    "이미지 업로드": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:...:function:UploadImage",
      "Next": "이미지 리사이징"
    },
    "이미지 리사이징": {
      "Type": "Parallel",
      "Branches": [
        {
          "StartAt": "썸네일 생성",
          "States": {
            "썸네일 생성": {
              "Type": "Task",
              "Resource": "arn:aws:lambda:...:function:CreateThumbnail",
              "End": true
            }
          }
        },
        {
          "StartAt": "중간 크기 생성",
          "States": {
            "중간 크기 생성": {
              "Type": "Task",
              "Resource": "arn:aws:lambda:...:function:CreateMedium",
              "End": true
            }
          }
        }
      ],
      "Next": "메타데이터 저장"
    },
    "메타데이터 저장": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:...:function:SaveMetadata",
      "End": true
    }
  }
}
```

### 예시 2: 주문 처리 워크플로
```
주문 접수
  ↓
주문 검증
  ├── 실패 → 주문 취소
  └── 성공 ↓
재고 확인
  ├── 재고 부족 → 재고 알림 → 대기
  └── 재고 있음 ↓
결제 처리
  ├── 실패 → 주문 취소
  └── 성공 ↓
배송 준비
  ↓
알림 전송 (병렬)
  ├── 이메일
  ├── SMS
  └── 푸시 알림
```

## 에러 처리

### 재시도 (Retry)
**정의**: 작업 실패 시 자동 재시도

**설정**:
```json
{
  "Retry": [
    {
      "ErrorEquals": ["States.ALL"],
      "IntervalSeconds": 2,
      "MaxAttempts": 3,
      "BackoffRate": 2.0
    }
  ]
}
```

**파라미터**:
- **ErrorEquals**: 재시도할 에러 유형
- **IntervalSeconds**: 재시도 간격
- **MaxAttempts**: 최대 재시도 횟수
- **BackoffRate**: 재시도 간격 증가율

### Catch (에러 처리)
**정의**: 특정 에러 발생 시 다른 경로로 이동

**예시**:
```json
{
  "Catch": [
    {
      "ErrorEquals": ["States.TaskFailed"],
      "Next": "에러 처리",
      "ResultPath": "$.error"
    }
  ]
}
```

### Dead Letter Queue
**정의**: 최종 실패한 실행을 저장

**설정**:
- SQS 큐 또는 SNS 토픽 지정
- 모든 재시도 실패 시 DLQ로 전송

## 모범 사례

### 1. 상태 머신 설계
- 단순하고 명확한 워크플로
- 재사용 가능한 구성 요소
- 적절한 에러 처리

### 2. 비용 최적화
- Express 실행 유형 사용 (가능한 경우)
- 불필요한 대기 시간 최소화
- 병렬 실행 활용

### 3. 모니터링
- CloudWatch 지표 모니터링
- 실행 이력 검토

### 4. 보안
- IAM 역할로 최소 권한 부여
- 민감한 데이터 암호화
- VPC 엔드포인트 사용 (필요 시)

## 관련 서비스

### Lambda
- Task 상태에서 가장 많이 사용
- 서버리스 함수 실행

### SQS
- DLQ로 사용
- 비동기 작업 큐

### SNS
- 알림 전송
- DLQ로 사용

### ECS/EKS
- 컨테이너 작업 실행
- Task 상태에서 사용

## 참고 자료
- [Step Functions 공식 문서](https://docs.aws.amazon.com/step-functions/)
- [Step Functions 모범 사례](https://docs.aws.amazon.com/step-functions/latest/dg/best-practices.html)

