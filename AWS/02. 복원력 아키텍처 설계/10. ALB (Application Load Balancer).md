# ALB (Application Load Balancer)

## 개요
Application Load Balancer (ALB)는 OSI 모델의 7계층(애플리케이션 계층)에서 작동하는 로드 밸런서입니다. HTTP/HTTPS 트래픽을 여러 대상에 분산시킵니다.

## 핵심 개념

### ALB란?
**정의**: 애플리케이션 레벨에서 트래픽을 분산하는 로드 밸런서

**주요 기능**:
- HTTP/HTTPS 트래픽 라우팅
- 경로 기반 라우팅
- 호스트 기반 라우팅
- SSL/TLS 종료
- 헬스 체크
- 여러 가용 영역에 분산

**작동 계층**: Layer 7 (애플리케이션 계층)

### 로드 밸런서 유형 비교

#### ALB (Application Load Balancer)
- **계층**: Layer 7 (HTTP/HTTPS)
- **라우팅**: 경로, 호스트, 헤더 기반
- **사용 사례**: 웹 애플리케이션, 마이크로서비스

#### NLB (Network Load Balancer)
- **계층**: Layer 4 (TCP/UDP)
- **라우팅**: IP, 포트 기반
- **사용 사례**: 고성능, 저지연 시간

#### CLB (Classic Load Balancer)
- **계층**: Layer 4/7
- **라우팅**: 기본 라우팅
- **사용 사례**: 레거시 애플리케이션

#### GLB (Gateway Load Balancer)
- **계층**: Layer 3 (IP)
- **라우팅**: IP 패킷 기반
- **사용 사례**: 보안 어플라이언스

## ALB 주요 기능

### 1. 경로 기반 라우팅 (Path-Based Routing)
**정의**: URL 경로에 따라 다른 대상 그룹으로 라우팅

**예시**:
```
/api/users → 사용자 서비스
/api/orders → 주문 서비스
/api/products → 제품 서비스
```

**구성**:
```
리스너 규칙:
- 경로: /api/users/* → 대상 그룹: users-service
- 경로: /api/orders/* → 대상 그룹: orders-service
- 기본 규칙 → 대상 그룹: default-service
```

**사용 사례**:
- 마이크로서비스 아키텍처
- 단일 ALB로 여러 서비스 라우팅

### 2. 호스트 기반 라우팅 (Host-Based Routing)
**정의**: HTTP Host 헤더에 따라 다른 대상 그룹으로 라우팅

**예시**:
```
api.example.com → API 서비스
admin.example.com → 관리자 서비스
www.example.com → 웹 서비스
```

**구성**:
```
리스너 규칙:
- 호스트: api.example.com → 대상 그룹: api-service
- 호스트: admin.example.com → 대상 그룹: admin-service
- 기본 규칙 → 대상 그룹: web-service
```

**사용 사례**:
- 여러 도메인을 단일 ALB로 관리
- 서브도메인별 서비스 분리

### 3. 헤더 기반 라우팅
**정의**: HTTP 헤더 값에 따라 라우팅

**예시**:
```
X-User-Type: mobile → 모바일 서비스
X-User-Type: web → 웹 서비스
```

### 4. 쿼리 문자열 기반 라우팅
**정의**: 쿼리 문자열에 따라 라우팅

**예시**:
```
?version=v1 → v1 서비스
?version=v2 → v2 서비스
```

### 5. SSL/TLS 종료
**정의**: ALB에서 SSL/TLS 암호화를 처리

**작동 원리**:
```
클라이언트 (HTTPS)
  ↓
ALB (SSL 종료)
  ↓ (HTTP)
대상 (EC2, ECS 등)
```

**장점**:
- 대상 서버에서 SSL 처리 불필요
- 인증서 관리 간소화
- 성능 향상

**인증서 관리**:
- AWS 관리형 인증서 사용
- 자동 인증서 갱신

### 6. 헬스 체크 (Health Check)
**정의**: 대상의 상태를 주기적으로 확인

**설정**:
- **경로**: 헬스 체크 경로 (예: /health)
- **간격**: 확인 주기 (기본 30초)
- **타임아웃**: 응답 대기 시간 (기본 5초)
- **건강 임계값**: 연속 성공 횟수 (기본 2)
- **비건강 임계값**: 연속 실패 횟수 (기본 2)

**작동 원리**:
```
ALB → 대상 1 (헬스 체크) → 정상 → 트래픽 전달
ALB → 대상 2 (헬스 체크) → 비정상 → 트래픽 차단
```

**상태**:
- **Healthy**: 정상, 트래픽 수신
- **Unhealthy**: 비정상, 트래픽 차단

### 7. Sticky Session (세션 고정)
**정의**: 동일한 클라이언트를 동일한 대상으로 라우팅

**사용 사례**:
- 세션 데이터를 서버에 저장하는 경우
- 상태 저장 애플리케이션

**주의사항**:
- 확장성 제한
- 장애 시 세션 손실
- 스테이트리스 설계 권장

## ALB 아키텍처

### 기본 구조
```
인터넷
  ↓
ALB (여러 가용 영역)
  ├── 가용 영역 A
  │   ├── 대상 그룹 1
  │   └── 대상 그룹 2
  └── 가용 영역 B
      ├── 대상 그룹 1
      └── 대상 그룹 2
```

### 대상 그룹 (Target Group)
**정의**: 트래픽을 받을 대상들의 그룹

**대상 유형**:
- EC2 인스턴스
- IP 주소
- Lambda 함수
- ECS 서비스

**특징**:
- 여러 대상 그룹 생성 가능
- 대상 그룹별 헬스 체크 설정
- 대상 그룹별 라우팅 규칙

### 리스너 (Listener)
**정의**: 특정 포트와 프로토콜에서 들어오는 연결을 처리

**포트**:
- HTTP: 80
- HTTPS: 443

**규칙**:
- 우선순위 순서로 평가
- 첫 번째 일치하는 규칙 적용
- 기본 규칙 (fallback)

## 사용 사례

### 시나리오 1: 마이크로서비스 라우팅
```
ALB
  ├── /api/users → 사용자 서비스 (ECS)
  ├── /api/orders → 주문 서비스 (ECS)
  └── /api/products → 제품 서비스 (Lambda)
```

### 시나리오 2: A/B 테스트
```
ALB
  ├── 헤더: X-Version=A → 버전 A 서비스
  └── 헤더: X-Version=B → 버전 B 서비스
```

### 시나리오 3: 블루/그린 배포
```
ALB
  ├── 가중치: 90% → 블루 서비스
  └── 가중치: 10% → 그린 서비스
```

### 시나리오 4: 컨테이너 오케스트레이션
```
ALB
  ↓
ECS 서비스 (Auto Scaling)
  ├── 작업 1
  ├── 작업 2
  └── 작업 3
```

## 고가용성

### Multi-AZ 배포
**필수**: ALB는 항상 여러 가용 영역에 배포

**장점**:
- 단일 AZ 장애 시에도 작동
- 높은 가용성

**구성**:
```
ALB
  ├── 가용 영역 A (서브넷 1)
  └── 가용 영역 B (서브넷 2)
```

### 대상 그룹 분산
**권장**: 대상 그룹도 여러 가용 영역에 분산

**구성**:
```
ALB
  ├── 가용 영역 A
  │   └── 대상 그룹 (인스턴스 A1, A2)
  └── 가용 영역 B
      └── 대상 그룹 (인스턴스 B1, B2)
```

## 모범 사례

### 1. 보안
- HTTPS 사용 (포트 443)
- 보안 그룹으로 액세스 제어
- WAF 통합

### 2. 성능
- 연결 유지 (Keep-Alive)
- 압축 활성화
- 적절한 타임아웃 설정

### 3. 모니터링
- CloudWatch 지표 모니터링
- 액세스 로그 활성화
- 헬스 체크 상태 확인

### 4. 비용 최적화
- 불필요한 대상 그룹 제거
- 적절한 용량 선택

## 비용

### ALB 비용
- 시간당: $0.0225
- LCU (Load Balancer Capacity Unit): 사용량 기반
  - 새 연결: 25개/초 = 1 LCU
  - 활성 연결: 3,000개 = 1 LCU
  - 처리된 바이트: 1GB/시간 = 1 LCU
  - 규칙 평가: 1,000개/초 = 1 LCU

### 비용 최적화
- 사용하지 않는 ALB 제거
- 규칙 수 최소화
- 연결 재사용

## 관련 서비스

### Auto Scaling
- 대상 그룹과 통합
- 트래픽에 따라 자동 확장

### ECS/EKS
- 컨테이너 서비스와 통합
- 서비스 디스커버리

### CloudWatch
- 지표 모니터링
- 알람 설정

### WAF
- 웹 애플리케이션 방화벽
- ALB와 통합

## 참고 자료
- [ALB 공식 문서](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/)
- [ALB 모범 사례](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/best-practices.html)
