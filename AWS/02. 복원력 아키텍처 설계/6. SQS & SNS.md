# SQS & SNS

## 개요
Amazon SQS (Simple Queue Service)와 Amazon SNS (Simple Notification Service)는 메시징 서비스로, 애플리케이션 간 느슨한 결합을 달성하는 핵심 서비스입니다.

## SQS (Simple Queue Service)

### SQS란?
**정의**: 완전 관리형 메시지 대기열 서비스

**핵심 개념**:
- **메시지**: 대기열에 저장되는 데이터 단위
- **대기열 (Queue)**: 메시지를 저장하는 컨테이너
- **생산자 (Producer)**: 메시지를 대기열에 보내는 애플리케이션
- **소비자 (Consumer)**: 대기열에서 메시지를 가져와 처리하는 애플리케이션

**작동 원리**:
```
생산자 → 메시지 전송 → 대기열 → 소비자 → 메시지 처리
```

### SQS 큐 유형

#### 1. 표준 큐 (Standard Queue)
**특징**:
- **무제한 처리량**: 초당 무제한 메시지 처리
- **최소 1회 전달**: 메시지가 최소 한 번은 전달됨 (중복 가능)
- **최선 노력 순서**: 메시지 순서 보장 안 됨
- **높은 가용성**: 99.999999999% (11개 9) 내구성

**사용 사례**:
- 높은 처리량이 필요한 경우
- 순서가 중요하지 않은 경우
- 중복 허용 가능한 경우

**예시**:
```
이미지 업로드 처리:
1. 사용자가 이미지 업로드
2. 메시지가 표준 큐에 전송
3. 여러 워커가 병렬로 메시지 처리
4. 순서와 관계없이 빠르게 처리
```

#### 2. FIFO 큐 (First-In-First-Out Queue)
**특징**:
- **정확히 1회 전달**: 메시지가 정확히 한 번만 전달 (중복 없음)
- **순서 보장**: 메시지가 전송된 순서대로 처리
- **제한된 처리량**: 초당 300개 메시지 (배치 시 3,000개)
- **메시지 그룹**: 그룹별로 순서 보장

**사용 사례**:
- 순서가 중요한 경우
- 중복을 허용할 수 없는 경우
- 처리량이 제한적이어도 되는 경우

**예시**:
```
주문 처리:
1. 주문 생성 메시지 (순서: 1, 2, 3)
2. FIFO 큐에 전송
3. 순서대로 처리 (1 → 2 → 3)
4. 중복 없이 정확히 한 번만 처리
```

### SQS 주요 기능

#### 1. 가시성 타임아웃 (Visibility Timeout)
**정의**: 메시지를 받은 후 다른 소비자가 볼 수 없게 하는 시간

**작동 원리**:
```
1. 소비자가 메시지 수신
2. 가시성 타임아웃 시작 (기본 30초)
3. 이 시간 동안 다른 소비자는 메시지 볼 수 없음
4. 처리 완료 시 메시지 삭제
5. 처리 실패 시 타임아웃 후 다시 보임
```

**설정**:
- 기본: 30초
- 최대: 12시간
- 메시지 처리 시간에 맞게 조정

#### 2. Dead Letter Queue (DLQ)
**정의**: 처리에 실패한 메시지를 저장하는 큐

**사용 목적**:
- 실패한 메시지 분석
- 재처리
- 디버깅

**설정**:
- 최대 수신 횟수 설정 (예: 3회)
- 3회 실패 시 DLQ로 이동

**예시**:
```
정상 처리:
메시지 → 큐 → 소비자 → 처리 성공 → 삭제

실패 처리:
메시지 → 큐 → 소비자 → 처리 실패 (1회)
메시지 → 큐 → 소비자 → 처리 실패 (2회)
메시지 → 큐 → 소비자 → 처리 실패 (3회)
→ DLQ로 이동
```

#### 3. 긴 폴링 (Long Polling)
**정의**: 메시지가 없을 때 최대 20초까지 대기하는 방식

**장점**:
- 빈 응답 감소
- 비용 절감
- 지연 시간 감소

**짧은 폴링 vs 긴 폴링**:

| 항목 | 짧은 폴링 | 긴 폴링 |
|------|----------|---------|
| **대기 시간** | 즉시 반환 | 최대 20초 대기 |
| **API 호출** | 많음 | 적음 |
| **비용** | 높음 | 낮음 |
| **지연 시간** | 높음 | 낮음 |

#### 4. 배치 작업
**정의**: 여러 메시지를 한 번에 전송/수신

**장점**:
- API 호출 감소
- 비용 절감
- 처리량 증가

**제한**:
- 표준 큐: 배치당 최대 10개 메시지
- FIFO 큐: 배치당 최대 10개 메시지, 같은 메시지 그룹

### SQS를 통한 느슨한 결합

**전통적인 강한 결합**:
```
웹 서버 → 직접 호출 → 데이터베이스
(웹 서버가 데이터베이스에 직접 의존)
```

**SQS를 사용한 느슨한 결합**:
```
웹 서버 → 메시지 전송 → SQS → 워커 → 데이터베이스
(웹 서버와 데이터베이스 간 직접 의존 없음)
```

**장점**:
- 웹 서버와 데이터베이스 독립적 확장
- 데이터베이스 장애 시 웹 서버 영향 없음
- 피크 시간 부하 완화

## SNS (Simple Notification Service)

### SNS란?
**정의**: Pub/Sub (발행/구독) 메시징 서비스

**핵심 개념**:
- **토픽 (Topic)**: 메시지를 발행하는 주제
- **발행자 (Publisher)**: 메시지를 토픽에 발행
- **구독자 (Subscriber)**: 토픽을 구독하여 메시지 수신

**작동 원리**:
```
발행자 → 토픽에 메시지 발행
  ↓
토픽
  ├── 구독자 1 (이메일)
  ├── 구독자 2 (SMS)
  ├── 구독자 3 (SQS)
  └── 구독자 4 (Lambda)
```

### SNS 구독 유형

#### 1. 이메일
**용도**: 이메일 알림 전송

**예시**:
```
이벤트 발생 → SNS 토픽 → 이메일 구독자
→ 관리자에게 이메일 알림
```

#### 2. SMS
**용도**: 문자 메시지 전송

**예시**:
```
주문 완료 → SNS 토픽 → SMS 구독자
→ 고객에게 주문 완료 문자
```

#### 3. SQS
**용도**: SQS 큐에 메시지 전달

**예시**:
```
이벤트 발생 → SNS 토픽 → SQS 큐
→ 비동기 처리
```

#### 4. Lambda
**용도**: Lambda 함수 트리거

**예시**:
```
이미지 업로드 → SNS 토픽 → Lambda 함수
→ 이미지 리사이징
```

#### 5. HTTP/HTTPS
**용도**: 웹훅 (Webhook) 전달

**예시**:
```
이벤트 발생 → SNS 토픽 → HTTP 엔드포인트
→ 외부 시스템에 알림
```

### SNS 주요 기능

#### 1. 필터링 (Filtering)
**정의**: 구독자별로 다른 메시지 수신

**예시**:
```
토픽: "주문 알림"
  ├── 필터: "주문 금액 > 10000"
  │   └── 구독자: 관리자 (고액 주문만)
  └── 필터: "모든 주문"
      └── 구독자: 일반 사용자 (모든 주문)
```

#### 2. 메시지 속성
**정의**: 메시지와 함께 전송되는 메타데이터

**용도**:
- 필터링
- 라우팅
- 메시지 분류

#### 3. 재시도 정책
**정의**: 전달 실패 시 자동 재시도

**설정**:
- 재시도 횟수
- 재시도 간격
- 백오프 전략

## SQS vs SNS 비교

### 패턴 비교

| 항목 | SQS | SNS |
|------|-----|-----|
| **패턴** | Point-to-Point (큐) | Pub/Sub (토픽) |
| **메시지 전달** | 단일 소비자 | 다중 구독자 |
| **메시지 보관** | 최대 14일 | 즉시 전달 (보관 안 됨) |
| **순서** | FIFO 큐만 순서 보장 | 순서 보장 안 됨 |
| **사용 사례** | 비동기 작업 처리 | 이벤트 알림, 브로드캐스트 |

### 함께 사용하기

**SNS → SQS 패턴**:
```
이벤트 발생
  ↓
SNS 토픽 (브로드캐스트)
  ├── SQS 큐 1 (주문 처리)
  ├── SQS 큐 2 (알림 전송)
  └── SQS 큐 3 (로깅)
```

**장점**:
- 여러 시스템에 동시 알림
- 각 시스템이 독립적으로 처리
- 느슨한 결합

## 느슨한 결합 달성

### 시나리오 1: 이벤트 기반 아키텍처
```
사용자 액션
  ↓
SNS 토픽 발행
  ├── Lambda (이미지 처리)
  ├── SQS (이메일 전송)
  └── Lambda (알림 전송)
```

### 시나리오 2: 마이크로서비스 통신
```
주문 서비스
  ↓ (주문 생성 이벤트)
SNS 토픽
  ├── 재고 서비스 (재고 차감)
  ├── 결제 서비스 (결제 처리)
  └── 배송 서비스 (배송 준비)
```

### 시나리오 3: 비동기 작업 처리
```
웹 서버
  ↓ (작업 요청)
SQS 큐
  ↓
워커 프로세스
  ↓ (작업 처리)
결과 저장
```

## 모범 사례

### SQS 모범 사례
1. **가시성 타임아웃 조정**: 처리 시간에 맞게 설정
2. **DLQ 사용**: 실패한 메시지 처리
3. **긴 폴링 사용**: 비용 절감
4. **배치 작업 활용**: 처리량 증가
5. **메시지 크기 최적화**: 256KB 제한 고려

### SNS 모범 사례
1. **토픽 분리**: 목적별로 토픽 분리
2. **필터링 활용**: 필요한 메시지만 수신
3. **재시도 정책 설정**: 전달 실패 처리
4. **Dead Letter Queue**: 실패한 메시지 처리

## 비용

### SQS
- 요청: 100만 요청당 $0.40
- 데이터 전송: GB당 $0.09

### SNS
- 발행: 100만 발행당 $0.50
- 전달: 프로토콜별 다름
  - HTTP/HTTPS: 100만 전달당 $0.60
  - 이메일: 1000건당 $0.02
  - SMS: 지역별 다름

## 관련 서비스

### Lambda
- SQS 큐에서 메시지 처리
- SNS 토픽 구독

### Step Functions
- 워크플로 오케스트레이션
- SQS/SNS와 통합

### EventBridge
- 이벤트 버스
- SNS와 유사하지만 더 많은 기능

## 참고 자료
- [SQS 공식 문서](https://docs.aws.amazon.com/sqs/)
- [SNS 공식 문서](https://docs.aws.amazon.com/sns/)
- [SQS 모범 사례](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-best-practices.html)

