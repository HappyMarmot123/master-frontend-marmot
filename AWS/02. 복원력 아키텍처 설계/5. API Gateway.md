# API Gateway

## 개요

Amazon API Gateway는 RESTful API와 WebSocket API를 생성, 게시, 유지 관리, 모니터링 및 보호하는 완전 관리형 서비스입니다. 마이크로서비스 아키텍처와 서버리스 애플리케이션의 핵심 구성 요소입니다.

## 핵심 개념

### API Gateway란?

**정의**: 클라이언트와 백엔드 서비스 간의 단일 진입점 역할을 하는 API 관리 서비스

**주요 기능**:

- API 생성 및 관리
- 요청 라우팅
- 인증 및 권한 부여
- 요청/응답 변환
- Rate Limiting
- 캐싱
- 모니터링 및 로깅

**왜 필요한가?**:

- 여러 백엔드 서비스를 단일 API로 통합
- 클라이언트와 백엔드 서비스 간 느슨한 결합
- API 버전 관리 및 배포
- 보안 및 인증 중앙 관리

### API 유형

#### 1. REST API

**정의**: RESTful 아키텍처 스타일을 따르는 HTTP API

**특징**:

- HTTP 메서드 사용 (GET, POST, PUT, DELETE)
- 리소스 기반 URL 구조
- JSON 형식 데이터 교환
- 상태 비저장 (Stateless)

**사용 사례**:

- 웹 애플리케이션
- 모바일 애플리케이션
- 마이크로서비스 통합

**예시**:

```
GET /users          → 사용자 목록 조회
GET /users/{id}     → 특정 사용자 조회
POST /users         → 사용자 생성
PUT /users/{id}     → 사용자 수정
DELETE /users/{id}  → 사용자 삭제
```

#### 2. HTTP API

**정의**: REST API의 경량 버전

**특징**:

- REST API보다 낮은 비용
- 더 빠른 성능
- OIDC 및 OAuth 2.0 지원
- CORS 자동 구성

**REST API vs HTTP API**:

| 항목          | REST API   | HTTP API    |
| ------------- | ---------- | ----------- |
| **비용**      | 높음       | 낮음        |
| **성능**      | 중간       | 높음        |
| **기능**      | 풍부       | 핵심 기능만 |
| **사용 사례** | 복잡한 API | 간단한 API  |

#### 3. WebSocket API

**정의**: 양방향 실시간 통신을 위한 API

**특징**:

- 지속적인 연결 유지
- 서버에서 클라이언트로 푸시 가능
- 실시간 데이터 교환

**사용 사례**:

- 채팅 애플리케이션
- 실시간 게임
- 실시간 알림
- 주식 시세 업데이트

## API Gateway 구성 요소

### 1. 리소스 (Resources)

**정의**: API의 엔드포인트 경로

**예시**:

```
/ (루트 리소스)
/users
/users/{userId}
/users/{userId}/orders
```

### 2. 메서드 (Methods)

**정의**: 리소스에 대한 HTTP 작업

**지원 메서드**:

- GET: 데이터 조회
- POST: 데이터 생성
- PUT: 데이터 수정
- DELETE: 데이터 삭제
- PATCH: 부분 수정
- OPTIONS: CORS 사전 요청

### 3. 통합 (Integration)

**정의**: API Gateway와 백엔드 서비스 간의 연결

**통합 유형**:

1. **Lambda 함수 통합**

   ```
   API Gateway → Lambda 함수
   ```

   - 서버리스 백엔드
   - 요청/응답 자동 변환

2. **HTTP 통합**

   ```
   API Gateway → HTTP 엔드포인트
   ```

   - 기존 웹 서버
   - EC2, ECS, 온프레미스 서버

3. **AWS 서비스 통합**

   ```
   API Gateway → AWS 서비스 (S3, DynamoDB 등)
   ```

   - 직접 AWS 서비스 호출
   - VTL (Velocity Template Language) 사용

4. **Mock 통합**
   ```
   API Gateway → Mock 응답
   ```
   - 테스트 및 프로토타이핑
   - 실제 백엔드 없이 API 테스트

### 4. 스테이지 (Stages)

**정의**: API의 배포 버전

**스테이지 예시**:

- `dev`: 개발 환경
- `staging`: 스테이징 환경
- `prod`: 프로덕션 환경

**스테이지별 설정**:

- 변수 (Variables)
- 캐싱 설정
- 로깅 설정
- Rate Limiting

### 5. 배포 (Deployment)

**정의**: API를 스테이지에 배포하는 과정

**특징**:

- 배포 후 변경사항 즉시 반영
- 롤백 가능
- 여러 스테이지에 독립적으로 배포

## 느슨한 결합 (Loose Coupling)

### 느슨한 결합이란?

**정의**: 시스템 구성 요소 간의 의존성을 최소화하는 아키텍처 패턴

**API Gateway의 역할**:

- 클라이언트와 백엔드 서비스 간 중간 계층
- 백엔드 변경 시 클라이언트 영향 최소화
- 여러 백엔드 서비스를 단일 API로 통합

### 작동 원리

```
클라이언트
  ↓
API Gateway (단일 진입점)
  ├── Lambda 함수 A
  ├── Lambda 함수 B
  ├── EC2 서버
  └── 외부 API
```

**장점**:

- 백엔드 서비스 변경 시 클라이언트 수정 불필요
- 여러 백엔드 서비스를 하나의 API로 통합
- 버전 관리 용이

### 실제 예시

```
초기 구성:
클라이언트 → API Gateway → Lambda 함수

백엔드 변경:
클라이언트 → API Gateway → ECS 서비스
           (클라이언트 변경 불필요)
```

## 주요 기능

### 1. 인증 및 권한 부여

#### IAM 권한

- IAM 역할/사용자 기반 인증
- 리소스 기반 정책
- 세밀한 권한 제어

#### Lambda Authorizer

- 커스텀 인증 로직
- 외부 인증 시스템 통합
- 토큰 검증 및 변환

### 2. 요청/응답 변환

**목적**: 클라이언트와 백엔드 간 데이터 형식 변환

**예시**:

```
클라이언트 요청 (JSON)
  ↓
API Gateway 변환
  ↓
백엔드 요청 (XML)
```

**VTL (Velocity Template Language)**:

- 요청/응답 변환에 사용
- 조건부 로직 가능
- 데이터 매핑

### 3. Rate Limiting

**정의**: API 호출 빈도 제한

**설정**:

- 초당 요청 수 제한
- 버스트 제한
- 계정별/API 키별 제한

**예시**:

```
Rate Limit: 1000 req/s
Burst: 2000 req/s

→ 초당 1000개 요청 허용
→ 짧은 시간 동안 최대 2000개 요청 허용
```

### 4. 캐싱

**목적**: 백엔드 부하 감소 및 응답 시간 단축

**캐싱 설정**:

- TTL (Time To Live) 설정
- 캐시 키 설정
- 스테이지별 캐시 설정

**작동 원리**:

```
첫 번째 요청:
클라이언트 → API Gateway → 백엔드 → 응답 캐시 저장

두 번째 요청:
클라이언트 → API Gateway → 캐시에서 응답 반환
```

### 5. CORS (Cross-Origin Resource Sharing)

**정의**: 다른 도메인에서 API 호출 허용

**설정**:

- 허용할 Origin 지정
- 허용할 HTTP 메서드
- 허용할 헤더

## 사용 사례

### 시나리오 1: 마이크로서비스 통합

```
클라이언트
  ↓
API Gateway
  ├── /users → 사용자 서비스 (Lambda)
  ├── /orders → 주문 서비스 (ECS)
  └── /products → 제품 서비스 (EC2)
```

### 시나리오 2: 서버리스 API

```
클라이언트
  ↓
API Gateway
  ├── Lambda 함수 1
  ├── Lambda 함수 2
  └── Lambda 함수 3
```

### 시나리오 3: 레거시 시스템 통합

```
클라이언트
  ↓
API Gateway
  ↓ (요청 변환)
온프레미스 서버 (레거시 시스템)
```

## 모범 사례

### 1. 버전 관리

- API 버전을 URL에 포함 (예: /v1/users)
- 여러 버전 동시 운영
- 점진적 마이그레이션

### 2. 에러 처리

- 표준화된 에러 응답
- 적절한 HTTP 상태 코드
- 에러 메시지 명확히

### 3. 보안

- HTTPS 사용
- 인증 필수
- Rate Limiting 설정
- 입력 검증

### 4. 성능 최적화

- 캐싱 활용
- 응답 압축
- 연결 풀링

### 5. 모니터링

- CloudWatch 지표 모니터링
- 로깅 활성화

## 비용

### REST API

- API 호출: 100만 요청당 $3.50
- 데이터 전송: GB당 $0.09

### HTTP API

- API 호출: 100만 요청당 $1.00
- 데이터 전송: GB당 $0.09

### WebSocket API

- 연결 시간: 100만 분당 $0.25
- 메시지: 100만 메시지당 $0.25

## 관련 서비스

### Lambda

- 서버리스 백엔드
- API Gateway와 통합

### CloudWatch

- 모니터링 및 로깅
- API 지표 수집

## 참고 자료

- [API Gateway 공식 문서](https://docs.aws.amazon.com/apigateway/)
- [API Gateway 모범 사례](https://docs.aws.amazon.com/apigateway/latest/developerguide/best-practices.html)
